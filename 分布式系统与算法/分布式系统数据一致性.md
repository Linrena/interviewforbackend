## åˆ†å¸ƒå¼ç³»ç»Ÿ

åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ä¸€ç»„[ç”µè„‘](https://zh.wikipedia.org/wiki/é›»å­è¨ˆç®—æ©Ÿ)ï¼Œé€è¿‡[ç½‘ç»œ](https://zh.wikipedia.org/wiki/è¨ˆç®—æ©Ÿç¶²çµ¡)ç›¸äº’è¿æ¥[ä¼ é€’æ¶ˆæ¯](https://zh.wikipedia.org/wiki/è¨Šæ¯å‚³é_(è»Ÿé«”))ä¸é€šä¿¡åå¹¶åè°ƒå®ƒä»¬çš„è¡Œä¸ºè€Œå½¢æˆçš„ç³»ç»Ÿã€‚ç»„ä»¶ä¹‹é—´å½¼æ­¤è¿›è¡Œäº¤äº’ä»¥å®ç°ä¸€ä¸ªå…±åŒçš„ç›®æ ‡ã€‚æŠŠéœ€è¦è¿›è¡Œå¤§é‡è®¡ç®—çš„å·¥ç¨‹æ•°æ®åˆ†å‰²æˆå°å—ï¼Œç”±å¤šå°[è®¡ç®—æœº](https://zh.wikipedia.org/wiki/é›»å­è¨ˆç®—æ©Ÿ)åˆ†åˆ«è®¡ç®—ï¼Œå†ä¸Šä¼ è¿ç®—ç»“æœåï¼Œå°†ç»“æœç»Ÿä¸€åˆå¹¶å¾—å‡ºæ•°æ®ç»“è®ºã€‚

[A distributed system is a computing environment in which various components are spread across multiple computers (or other computing devices) on a network. These devices split up the work, coordinating their efforts to complete the job more efficiently than if a single device had been responsible for the task.](https://www.splunk.com/en_us/data-insider/what-are-distributed-systems.html) [From Splunk]

## CAP ç†è®º

åˆ†å¸ƒå¼ç³»ç»Ÿ CAP ç†è®ºï¼Œå³å¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿè€Œè¨€ï¼Œå®ƒæ˜¯æ— æ³•åŒæ—¶æ»¡è¶³ Consistency(å¼ºä¸€è‡´æ€§)ã€Availability(å¯ç”¨æ€§) å’Œ Partition Tolerance(åˆ†åŒºå®¹å¿æ€§) è¿™ä¸‰ä¸ªç‰¹æ€§çš„ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³å…¶ä¸­ä¸¤ä¸ªã€‚

ä½†åœ¨å®é™…åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”±äºç½‘ç»œç¯å¢ƒæ˜¯ä¸å¯ä¿¡çš„ï¼Œæ‰€ä»¥åˆ†åŒºå®¹å¿æ€§å‡ ä¹æ˜¯å¿…é€‰çš„ï¼Œè®¾è®¡è€…åŸºæœ¬å°±æ˜¯åœ¨ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ä¹‹é—´åšé€‰æ‹©ï¼Œå½“ç„¶å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¤§å®¶éƒ½ä¼šé€‰æ‹©ç‰ºç‰²ä¸€éƒ¨åˆ†çš„ä¸€è‡´æ€§æ¥ä¿è¯å¯ç”¨æ€§ï¼ˆå¯ç”¨æ€§è¾ƒå·®çš„ç³»ç»Ÿéå¸¸å½±å“ç”¨æˆ·ä½“éªŒçš„ï¼Œä½†æ˜¯å¯¹å¦ä¸€äº›åœºæ™¯ï¼Œæ¯”å¦‚æ”¯ä»˜åœºæ™¯ï¼Œå¼ºä¸€è‡´æ€§æ˜¯å¿…é¡»çš„ï¼‰ã€‚

- **ä¸€è‡´æ€§ï¼š**å¯¹äºå®¢æˆ·ç«¯çš„æ¯æ¬¡è¯»æ“ä½œï¼Œè¦ä¹ˆè¯»åˆ°çš„æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œè¦ä¹ˆè¯»å–å¤±è´¥ã€‚æ¢å¥è¯è¯´ï¼Œä¸€è‡´æ€§æ˜¯ç«™åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„è§’åº¦ï¼Œå¯¹è®¿é—®æœ¬ç³»ç»Ÿçš„å®¢æˆ·ç«¯çš„ä¸€ç§æ‰¿è¯ºï¼šè¦ä¹ˆæˆ‘ç»™æ‚¨è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œè¦ä¹ˆæˆ‘ç»™ä½ è¿”å›ç»å¯¹ä¸€è‡´çš„æœ€æ–°æ•°æ®ï¼Œä¸éš¾çœ‹å‡ºï¼Œå…¶å¼ºè°ƒçš„æ˜¯æ•°æ®æ­£ç¡®ã€‚
- **å¯ç”¨æ€§ï¼š**ä»»ä½•å®¢æˆ·ç«¯çš„è¯·æ±‚éƒ½èƒ½å¾—åˆ°å“åº”æ•°æ®ï¼Œä¸ä¼šå‡ºç°å“åº”é”™è¯¯ã€‚æ¢å¥è¯è¯´ï¼Œå¯ç”¨æ€§æ˜¯ç«™åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„è§’åº¦ï¼Œå¯¹è®¿é—®æœ¬ç³»ç»Ÿçš„å®¢æˆ·çš„å¦ä¸€ç§æ‰¿è¯ºï¼šæˆ‘ä¸€å®šä¼šç»™æ‚¨è¿”å›æ•°æ®ï¼Œä¸ä¼šç»™ä½ è¿”å›é”™è¯¯ï¼Œä½†ä¸ä¿è¯æ•°æ®æœ€æ–°ï¼Œå¼ºè°ƒçš„æ˜¯ä¸å‡ºé”™ã€‚
- **åˆ†åŒºå®¹å¿æ€§ï¼š**ç”±äºåˆ†å¸ƒå¼ç³»ç»Ÿé€šè¿‡ç½‘ç»œè¿›è¡Œé€šä¿¡ï¼Œç½‘ç»œæ˜¯ä¸å¯é çš„ã€‚å½“ä»»æ„æ•°é‡çš„æ¶ˆæ¯ä¸¢å¤±æˆ–å»¶è¿Ÿåˆ°è¾¾æ—¶ï¼Œç³»ç»Ÿä»ä¼šç»§ç»­æä¾›æœåŠ¡ï¼Œä¸ä¼šæŒ‚æ‰ã€‚æ¢å¥è¯è¯´ï¼Œåˆ†åŒºå®¹å¿æ€§æ˜¯ç«™åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„è§’åº¦ï¼Œå¯¹è®¿é—®æœ¬ç³»ç»Ÿçš„å®¢æˆ·ç«¯çš„å†ä¸€ç§æ‰¿è¯ºï¼šæˆ‘ä¼šä¸€ç›´è¿è¡Œï¼Œä¸ç®¡æˆ‘çš„å†…éƒ¨å‡ºç°ä½•ç§æ•°æ®åŒæ­¥é—®é¢˜ï¼Œå¼ºè°ƒçš„æ˜¯ä¸æŒ‚æ‰ã€‚

![img](../shortcuts/(null)-20220305163055943.(null))

å¾ˆå¤š NoSQL æ•°æ®åº“éƒ½æ˜¯ AP å‹çš„ï¼Œå…¶ä¸­æœ€å¸¸è§çš„ MongoDB æ˜¯ CP å‹çš„ã€‚

![img](../shortcuts/(null)-20220305163055954.(null))

2PC å’Œ 3PC æ˜¯ CA å‹çš„ï¼ŒPaxos å’Œ Raft æ˜¯ CP å‹çš„ï¼Œè€Œ MVCC æ˜¯ AP å‹çš„ã€‚

## ä¸€è‡´æ€§

ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰æ˜¯æŒ‡å¤šå‰¯æœ¬ï¼ˆReplicationsï¼‰é—®é¢˜ä¸­çš„æ•°æ®ä¸€è‡´æ€§ï¼ˆç”±å¤šæ•°æ®æ‹·è´å¸¦æ¥çš„é—®é¢˜è€Œä¸æ˜¯å¤šå¹¶å‘è¯»å†™ï¼‰ã€‚å…³äºåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€è‡´æ€§æ¨¡å‹æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- **å¼ºä¸€è‡´æ€§ï¼š**å½“æ›´æ–°æ“ä½œå®Œæˆä¹‹åï¼Œä»»ä½•å¤šä¸ªåç»­è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„è®¿é—®éƒ½ä¼šè¿”å›æœ€æ–°çš„æ›´æ–°è¿‡çš„å€¼ï¼Œç›´åˆ°è¿™ä¸ªæ•°æ®è¢«å…¶ä»–æ•°æ®æ›´æ–°ä¸ºæ­¢ã€‚ä½†æ˜¯è¿™ç§å®ç°å¯¹æ€§èƒ½å½±å“è¾ƒå¤§ï¼Œå› ä¸ºè¿™æ„å‘³ç€ï¼Œåªè¦ä¸Šæ¬¡çš„æ“ä½œæ²¡æœ‰å¤„ç†å®Œï¼Œå°±ä¸èƒ½è®©ç”¨æˆ·è¯»å–æ•°æ®ã€‚

- **å¼±ä¸€è‡´æ€§ï¼š**ç³»ç»Ÿå¹¶ä¸ä¿è¯è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„è®¿é—®éƒ½ä¼šè¿”å›æœ€æ–°æ›´æ–°è¿‡çš„å€¼ã€‚ç³»ç»Ÿåœ¨æ•°æ®å†™å…¥æˆåŠŸä¹‹åï¼Œä¸æ‰¿è¯ºç«‹å³å¯ä»¥è¯»åˆ°æœ€æ–°å†™å…¥çš„å€¼ï¼Œä¹Ÿä¸ä¼šå…·ä½“çš„æ‰¿è¯ºå¤šä¹…ä¹‹åå¯ä»¥è¯»åˆ°ã€‚ç”šè‡³ä¸èƒ½ä¿è¯å¯ä»¥è®¿é—®åˆ°ã€‚

- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šæœ€ç»ˆä¸€è‡´æ€§ä¹Ÿæ˜¯å¼±ä¸€è‡´æ€§çš„ä¸€ç§ï¼Œå®ƒæ— æ³•ä¿è¯æ•°æ®æ›´æ–°åï¼Œæ‰€æœ‰åç»­çš„è®¿é—®éƒ½èƒ½çœ‹åˆ°æœ€æ–°æ•°å€¼ï¼Œè€Œæ˜¯éœ€è¦ä¸€ä¸ªæ—¶é—´ï¼Œåœ¨è¿™ä¸ªæ—¶é—´ä¹‹åå¯ä»¥ä¿è¯è¿™ä¸€ç‚¹ï¼ˆå°±æ˜¯åœ¨ä¸€æ®µæ—¶é—´åï¼ŒèŠ‚ç‚¹é—´çš„æ•°æ®ä¼šæœ€ç»ˆè¾¾åˆ°ä¸€è‡´çŠ¶æ€ï¼‰ï¼Œè€Œåœ¨è¿™ä¸ªæ—¶é—´å†…ï¼Œæ•°æ®ä¹Ÿè®¸æ˜¯ä¸ä¸€è‡´çš„ï¼Œè¿™ä¸ªç³»ç»Ÿæ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§çš„æ—¶é—´ç‰‡æ®µè¢«ç§°ä¸ºã€Œä¸ä¸€è‡´çª—å£ã€ã€‚ä¸ä¸€è‡´çª—å£çš„æ—¶é—´é•¿çŸ­å–å†³äºå¾ˆå¤šå› ç´ ï¼Œæ¯”å¦‚å¤‡ä»½æ•°æ®çš„ä¸ªæ•°ã€ç½‘ç»œä¼ è¾“å»¶è¿Ÿé€Ÿåº¦ã€ç³»ç»Ÿè´Ÿè½½ç­‰ã€‚

# åè®®ä¸ç®—æ³•

## åˆ†å¸ƒå¼äº‹åŠ¡ä¸å…±è¯†

åˆ†å¸ƒå¼äº‹åŠ¡ï¼šäºŒé˜¶æ®µã€ä¸‰é˜¶æ®µ

å…±è¯†ç®—æ³•ï¼šRaftã€Paxos

å…³ç³»ï¼š

åƒä¸¤é˜¶æ®µå’Œä¸‰é˜¶æ®µæäº¤åè®®éƒ½æ˜¯ç”¨æ¥æ”¯æ’‘åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§çš„ï¼Œè€Œ Paxosã€Raft ä»¥åŠ ZAB æ˜¯ç”¨æ¥è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®å¤šå‰¯æœ¬ä¹‹é—´çš„ä¸€è‡´æ€§ï¼Œå³è¾¾æˆâ€œå…±è¯†â€ï¼Œæˆ‘ä»¬è¦å°†å…±è¯†å’Œäº‹åŠ¡ä¸€è‡´æ€§åˆ†å¼€çœ‹å¾…ï¼Œè¿™ä¸¤è€…å¹¶ä¸æ˜¯ä¸€å›äº‹ã€‚ç®€å•æ¥è¯´ï¼š

- **åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§**ä¼šå› ä¸ºå¼•å…¥åè°ƒè€…è€Œå‡ºç°å•ç‚¹å¯ç”¨æ€§é—®é¢˜
- ä¸ºäº†è§£å†³å¯ç”¨æ€§é—®é¢˜ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡çš„èŠ‚ç‚¹éœ€è¦åœ¨åè°ƒè€…æ•…éšœæ—¶å°±æ–°åè°ƒè€…é€‰å–è¾¾æˆ**å…±è¯†**
- **è§£å†³å…±è¯†é—®é¢˜**ç­‰ä»·äºå®ç°ä¸€ä¸ª**çº¿æ€§ä¸€è‡´**å­˜å‚¨ï¼ˆçº¿æ€§ä¸€è‡´ï¼Œlinearabilityï¼ŒæŒ‡**å¤šå‰¯æœ¬çš„ç³»ç»Ÿèƒ½å¤Ÿå¯¹å¤–è¡¨ç°åœ°åƒåªæœ‰å•ä¸ªå‰¯æœ¬ä¸€æ ·ä¸”**ç³»ç»Ÿä¿è¯ä»ä»»ä½•å‰¯æœ¬è¯»å–åˆ°çš„å€¼éƒ½æ˜¯æœ€æ–°çš„ï¼Œå³å¼ºä¸€è‡´æ€§ï¼‰
- **è§£å†³çº¿æ€§ä¸€è‡´é—®é¢˜å°±è¦**å®ç°**å…¨åºå¹¿æ’­ï¼ˆtotal order boardcastï¼‰è€ŒPaxos/Raft å®ç°äº†å…¨åºå¹¿æ’­**

ä½†ä»å…±æ€§ä¸Šæ¥è®²ï¼Œä¸Šé¢è¿™äº›åè®®ä¸ç®—æ³•éƒ½æ˜¯ç”¨æ¥è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§çš„ç›¸å…³é—®é¢˜ã€‚

## 2PC ä¸¤é˜¶æ®µæäº¤

äºŒé˜¶æ®µæäº¤åè®®ï¼ˆTwo-phase Commitï¼Œå³ 2PCï¼‰æ˜¯å¸¸ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥ä¿è¯åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼Œè¦ä¹ˆæ‰€æœ‰å‚ä¸è¿›ç¨‹éƒ½æäº¤äº‹åŠ¡ï¼Œè¦ä¹ˆéƒ½å–æ¶ˆäº‹åŠ¡ï¼Œå³å®ç° ACID çš„åŸå­æ€§ï¼ˆAï¼‰ã€‚åœ¨æ•°æ®ä¸€è‡´æ€§ä¸­ï¼Œå®ƒçš„å«ä¹‰æ˜¯ï¼šè¦ä¹ˆæ‰€æœ‰å‰¯æœ¬ï¼ˆå¤‡ä»½æ•°æ®ï¼‰åŒæ—¶ä¿®æ”¹æŸä¸ªæ•°å€¼ï¼Œè¦ä¹ˆéƒ½ä¸æ›´æ”¹ï¼Œä»¥æ­¤æ¥ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚

2PC è¦è§£å†³çš„é—®é¢˜å¯ä»¥ç®€å•æ€»ç»“ä¸ºï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹è™½ç„¶å¯ä»¥çŸ¥é“è‡ªå·±çš„æ“ä½œæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œå´æ˜¯æ— æ³•çŸ¥é“å…¶ä»–èŠ‚ç‚¹çš„æ“ä½œçŠ¶æ€ã€‚å½“ä¸€ä¸ªäº‹åŠ¡éœ€è¦è·¨è¶Šå¤šä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¸ºäº†ä¿æŒäº‹åŠ¡çš„ ACID ç‰¹æ€§ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªä½œä¸º**åè°ƒè€…**çš„ç»„ä»¶æ¥ç»Ÿä¸€æŒæ§æ‰€æœ‰èŠ‚ç‚¹ï¼ˆå‚ä¸è€…ï¼‰çš„æ“ä½œç»“æœå¹¶æœ€ç»ˆæŒ‡ç¤ºè¿™äº›èŠ‚ç‚¹æ˜¯å¦è¦æŠŠæ“ä½œç»“æœè¿›è¡ŒçœŸæ­£çš„æäº¤ï¼ˆæ¯”å¦‚å°†æ›´æ–°åçš„æ•°æ®å†™å…¥ç£ç›˜ç­‰ç­‰ï¼‰ã€‚å› æ­¤ï¼ŒäºŒé˜¶æ®µæäº¤çš„ç®—æ³•æ€è·¯å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š å‚ä¸è€…å°†æ“ä½œç»“æœé€šçŸ¥åè°ƒè€…ï¼Œå†ç”±åè°ƒè€…æ ¹æ®æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆæƒ…æŠ¥å†³å®šå„å‚ä¸è€…æ˜¯å¦è¦æäº¤æ“ä½œè¿˜æ˜¯ä¸­æ­¢æ“ä½œã€‚

### 2PC è¿‡ç¨‹

å…³äºä¸¤é˜¶æ®µæäº¤çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](../shortcuts/(null)-20220305163056013.(null))

ä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹

é¡¾åæ€ä¹‰ï¼Œ2PC åˆ†ä¸ºä¸¤ä¸ªè¿‡ç¨‹ï¼š

1. è¡¨å†³é˜¶æ®µï¼šæ­¤æ—¶ Coordinator ï¼ˆåè°ƒè€…ï¼‰å‘æ‰€æœ‰çš„å‚ä¸è€…å‘é€ä¸€ä¸ª vote requestï¼Œå‚ä¸è€…åœ¨æ”¶åˆ°è¿™è¯·æ±‚åï¼Œå¦‚æœå‡†å¤‡å¥½äº†å°±ä¼šå‘ Coordinator å‘é€ä¸€ä¸ª `VOTE_COMMIT` æ¶ˆæ¯ä½œä¸ºå›åº”ï¼Œå‘ŠçŸ¥ Coordinator è‡ªå·±å·²ç»åšå¥½äº†å‡†å¤‡ï¼Œå¦åˆ™ä¼šè¿”å›ä¸€ä¸ª `VOTE_ABORT` æ¶ˆæ¯ï¼›
2. æäº¤é˜¶æ®µï¼šCoordinator æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„è¡¨å†³ä¿¡æ¯ï¼Œå¦‚æœæ‰€æœ‰å‚ä¸è€…ä¸€è‡´è®¤ä¸ºå¯ä»¥æäº¤äº‹åŠ¡ï¼Œé‚£ä¹ˆ Coordinator å°±ä¼šå‘é€ `GLOBAL_COMMIT` æ¶ˆæ¯ï¼Œå¦åˆ™å‘é€ `GLOBAL_ABORT` æ¶ˆæ¯ï¼›å¯¹äºå‚ä¸è€…è€Œè¨€ï¼Œå¦‚æœæ”¶åˆ° `GLOBAL_COMMIT` æ¶ˆæ¯ï¼Œå°±ä¼šæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œå¦åˆ™å°±ä¼šå–æ¶ˆæœ¬åœ°äº‹åŠ¡ï¼ˆä¿è¯äº†æ•°æ®å¼ºä¸€è‡´æ€§ï¼‰ã€‚

### 2PC ä¸€è‡´æ€§é—®é¢˜

è¿™é‡Œå…ˆè®¨è®ºä¸€ä¸‹ï¼Œ2PC æ˜¯å¦å¯ä»¥åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½å¯ä»¥è§£å†³ä¸€è‡´æ€§é—®é¢˜ï¼Œåœ¨å®é™…çš„ç½‘ç»œç”Ÿäº§ä¸­ï¼Œå„ç§æƒ…å†µéƒ½æœ‰å¯èƒ½å‘ç”Ÿï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆä»ç†è®ºä¸Šåˆ†æå„ç§æ„å¤–æƒ…å†µã€‚

2PC åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿ Coordinator æˆ–è€…å‚ä¸è€…çªç„¶å®•æœºçš„æƒ…å†µï¼Œåœ¨ä¸åŒæ—¶æœŸå®•æœºå¯èƒ½æœ‰ä¸åŒçš„ç°è±¡ã€‚

ç¬¬ä¸€ç§æƒ…å†µï¼ŒCoordinator å’Œå‚ä¸è€…ä¸¤è€…æŒ‚å…¶ä¸€ï¼š

æ— æ³•å¤åˆ¶åŠ è½½ä¸­çš„å†…å®¹

åŒæ—¶æŒ‚ï¼Œåˆ†ä¸ºå‡ ç§ç±»å‹æ¥è®¨è®ºï¼š

æ— æ³•å¤åˆ¶åŠ è½½ä¸­çš„å†…å®¹

### 2PC ä¼˜ç¼ºç‚¹

ç®€å•æ€»ç»“ä¸€ä¸‹ 2PC çš„ä¼˜ç¼ºç‚¹ï¼š

- ä¼˜ç‚¹ï¼šåŸç†ç®€æ´æ¸…æ™°ã€å®ç°æ–¹ä¾¿ï¼›

- ç¼ºç‚¹ï¼šåŒæ­¥é˜»å¡ã€å•ç‚¹é—®é¢˜ã€å°æ¦‚ç‡æ•°æ®ä¸å¼ºä¸€è‡´ã€‚

å‰ä¸¤ä¸ªç¼ºç‚¹ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯¹ 2PC åšç›¸åº”çš„æ”¹é€ ï¼š

1. åŒæ­¥é˜»å¡ï¼šCoordinator ç­‰å¾…æ‰€æœ‰å‚ä¸è€…è¡¨å†³çš„è¿‡ç¨‹ä¸­æ˜¯åŒæ­¥é˜»å¡çš„ï¼Œåœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å‚ä¸è€…é•¿é˜»å¡é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯é€šè¿‡è¶…æ—¶åˆ¤æ–­æœºåˆ¶æ¥è§£å†³çš„ï¼ˆé˜²æ­¢æŸä¸ªå‚ä¸è€…æŒ‚äº†è€Œé•¿æ—¶é—´é˜»å¡ï¼‰ï¼Œä½†å¹¶ä¸èƒ½å®Œå…¨è§£å†³åŒæ­¥é˜»å¡é—®é¢˜ï¼›
2. Coordinator å•ç‚¹é—®é¢˜ï¼šå®é™…ç”Ÿäº§åº”ç”¨ä¸­ï¼ŒCoordinator éƒ½ä¼šæœ‰ç›¸åº”çš„å¤‡é€‰èŠ‚ç‚¹ï¼›





## 3PC ä¸‰é˜¶æ®µæäº¤

ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆThree-Phase Commitï¼Œ 3PCï¼‰æœ€å…³é”®è¦è§£å†³çš„å°±æ˜¯ä¸¤é˜¶æ®µæäº¤åè®®è¿‡ç¨‹ä¸­çš„åŒæ­¥é˜»å¡é—®é¢˜ï¼Œæ‰€ä»¥ 3PC åœ¨ 2PC ä¸­åˆæ·»åŠ ä¸€ä¸ªé˜¶æ®µï¼Œè¿™æ ·ä¸‰é˜¶æ®µæäº¤å°±æœ‰ï¼šCanCommitã€PreCommit å’Œ DoCommit ä¸‰ä¸ªé˜¶æ®µã€‚

3PC é€šè¿‡ä»¥ä¸‹æ‰‹æ®µé™ä½äº†é˜»å¡ï¼š

- å‚ä¸è€…è¿”å› CanCommit è¯·æ±‚çš„å“åº”åï¼Œç­‰å¾…ç¬¬äºŒé˜¶æ®µæŒ‡ä»¤ï¼Œè‹¥ç­‰å¾…è¶…æ—¶ï¼Œåˆ™è‡ªåŠ¨ abortï¼Œå‡å°‘é˜»å¡ï¼›
- å‚ä¸è€…è¿”å› PreCommit è¯·æ±‚çš„å“åº”åï¼Œç­‰å¾…ç¬¬ä¸‰é˜¶æ®µæŒ‡ä»¤ï¼Œè‹¥ç­‰å¾…è¶…æ—¶ï¼Œåˆ™è‡ªåŠ¨ commit äº‹åŠ¡ï¼Œä¹Ÿå‡å°‘äº†é˜»å¡ï¼›

### 3PC è¿‡ç¨‹

ä¸‰é˜¶æ®µæäº¤åè®®çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](../shortcuts/(null))

3PC çš„è¯¦ç»†è¿‡ç¨‹ï¼š

#### é˜¶æ®µä¸€ CanCommitï¼ˆè¯¢é—®ï¼‰

1. äº‹åŠ¡è¯¢é—®ï¼šCoordinator å‘å„å‚ä¸è€…å‘é€ CanCommit çš„è¯·æ±‚ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œå¹¶å¼€å§‹ç­‰å¾…å„å‚ä¸è€…çš„å“åº”ï¼›
2. å‚ä¸è€…å‘ Coordinator åé¦ˆè¯¢é—®çš„å“åº”ï¼šå‚ä¸è€…æ”¶åˆ° CanCommit è¯·æ±‚åï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœè‡ªèº«è®¤ä¸ºå¯ä»¥é¡ºåˆ©æ‰§è¡Œäº‹åŠ¡ï¼Œé‚£ä¹ˆä¼šåé¦ˆ Yes å“åº”ï¼Œå¹¶è¿›å…¥é¢„å¤‡çŠ¶æ€ï¼Œå¦åˆ™åé¦ˆ Noã€‚

#### é˜¶æ®µäºŒ PreCommitï¼ˆæ‰§è¡Œï¼‰

**æ‰§è¡Œäº‹åŠ¡é¢„æäº¤**ï¼šå¦‚æœ Coordinator æ¥æ”¶åˆ°å„å‚ä¸è€…åé¦ˆéƒ½æ˜¯ Yesï¼Œé‚£ä¹ˆæ‰§è¡Œäº‹åŠ¡é¢„æäº¤ï¼š

1. å‘é€é¢„æäº¤è¯·æ±‚ï¼šCoordinator å‘å„å‚ä¸è€…å‘é€ preCommit è¯·æ±‚ï¼Œå¹¶è¿›å…¥ prepared é˜¶æ®µï¼›
2. äº‹åŠ¡é¢„æäº¤ï¼šå‚ä¸è€…æ¥æ”¶åˆ° preCommit è¯·æ±‚åï¼Œä¼šæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå¹¶å°† Undo å’Œ Redo ä¿¡æ¯è®°å½•åˆ°äº‹åŠ¡æ—¥è®°ä¸­ï¼›
3. å„å‚ä¸è€…å‘ Coordinator åé¦ˆäº‹åŠ¡æ‰§è¡Œçš„å“åº”ï¼šå¦‚æœå‚ä¸è€…æˆåŠŸæ‰§è¡Œäº†äº‹åŠ¡æ“ä½œï¼Œé‚£ä¹ˆåé¦ˆç»™åè°ƒè€… ACK å“åº”ï¼ŒåŒæ—¶ç­‰å¾…æœ€ç»ˆæŒ‡ä»¤è¿›è¡Œ commit æˆ–è€… abortï¼›

**ä¸­æ–­äº‹åŠ¡**ï¼šå¦‚æœä»»ä½•ä¸€ä¸ªå‚ä¸è€…å‘ Coordinator åé¦ˆäº† No å“åº”ï¼Œæˆ–è€…åœ¨ç­‰å¾…è¶…æ—¶åï¼ŒCoordinator æ— æ³•æ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆï¼Œé‚£ä¹ˆå°±ä¼šä¸­æ–­äº‹åŠ¡ã€‚

1. å‘é€ä¸­æ–­è¯·æ±‚ï¼šCoordinator å‘æ‰€æœ‰å‚ä¸è€…å‘é€ abort è¯·æ±‚ï¼›
2. ä¸­æ–­äº‹åŠ¡ï¼šæ— è®ºæ˜¯æ”¶åˆ°æ¥è‡ª Coordinator çš„ abort è¯·æ±‚ï¼Œè¿˜æ˜¯ç­‰å¾…è¶…æ—¶ï¼Œå‚ä¸è€…éƒ½ä¸­æ–­äº‹åŠ¡ã€‚

#### é˜¶æ®µä¸‰ DoCommitï¼ˆæäº¤ï¼‰

**æ‰§è¡Œæäº¤**

1. å‘é€æäº¤è¯·æ±‚ï¼šå‡è®¾ Coordinator æ­£å¸¸å·¥ä½œï¼Œæ¥æ”¶åˆ°äº†æ‰€æœ‰å‚ä¸è€…çš„ ack å“åº”ï¼Œé‚£ä¹ˆå®ƒå°†ä»é¢„æäº¤é˜¶æ®µè¿›å…¥æäº¤çŠ¶æ€ï¼Œå¹¶å‘æ‰€æœ‰å‚ä¸è€…å‘é€ doCommit è¯·æ±‚ï¼›
2. äº‹åŠ¡æäº¤ï¼šå‚ä¸è€…æ”¶åˆ° doCommit è¯·æ±‚åï¼Œæ­£å¼æäº¤äº‹åŠ¡ï¼Œå¹¶åœ¨å®Œæˆäº‹åŠ¡æäº¤åé‡Šæ”¾å ç”¨çš„èµ„æºï¼›
3. åé¦ˆäº‹åŠ¡æäº¤ç»“æœï¼šå‚ä¸è€…å®Œæˆäº‹åŠ¡æäº¤åï¼Œå‘ Coordinator å‘é€ ACK ä¿¡æ¯ï¼›
4. å®Œæˆäº‹åŠ¡ï¼šCoordinator æ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€… ack ä¿¡æ¯ï¼Œå®Œæˆäº‹åŠ¡ã€‚

**ä¸­æ–­äº‹åŠ¡**ï¼šå‡è®¾ Coordinator æ­£å¸¸å·¥ä½œï¼Œå¹¶ä¸”æœ‰ä»»ä¸€å‚ä¸è€…åé¦ˆ Noï¼Œæˆ–è€…åœ¨ç­‰å¾…è¶…æ—¶åæ— æ³•æ¥æ”¶æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆï¼Œéƒ½ä¼šä¸­æ–­äº‹åŠ¡

1. å‘é€ä¸­æ–­è¯·æ±‚ï¼šCoordinator å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘é€ abort è¯·æ±‚ï¼›
2. äº‹åŠ¡å›æ»šï¼šå‚ä¸è€…æ¥æ”¶åˆ° abort è¯·æ±‚åï¼Œåˆ©ç”¨ undo æ—¥å¿—æ‰§è¡Œäº‹åŠ¡å›æ»šï¼Œå¹¶åœ¨å®Œæˆäº‹åŠ¡å›æ»šåé‡Šæ”¾å ç”¨çš„èµ„æºï¼›
3. åé¦ˆäº‹åŠ¡å›æ»šç»“æœï¼šå‚ä¸è€…åœ¨å®Œæˆäº‹åŠ¡å›æ»šä¹‹åï¼Œå‘ Coordinator å‘é€ ack ä¿¡æ¯ï¼›
4. ä¸­æ–­äº‹åŠ¡ï¼šCoordinator æ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„ ack ä¿¡æ¯åï¼Œä¸­æ–­äº‹åŠ¡ã€‚

### 3PC åˆ†æ

3PC è™½ç„¶å‡å°‘äº†åŒæ­¥é˜»å¡ï¼Œä½†ä¾ç„¶å­˜åœ¨å…¶ä»–é—®é¢˜ï¼Œæ¯”å¦‚ç½‘ç»œåˆ†åŒºé—®é¢˜ã€‚åœ¨ preCommit æ¶ˆæ¯å‘é€åçªç„¶ä¸¤ä¸ªæœºæˆ¿æ–­å¼€ï¼Œè¿™æ—¶å€™ Coordinator æ‰€åœ¨æœºæˆ¿ä¼š abort, å¦å¤–å‰©ä½™å‚ä¸è€…çš„æœºæˆ¿åˆ™ä¼š commitï¼ˆCA without Pï¼‰ã€‚

è€Œä¸”ç”±äº3PC çš„è®¾è®¡è¿‡äºå¤æ‚ï¼Œåœ¨è§£å†³2PC é—®é¢˜çš„åŒæ—¶ä¹Ÿå¼•å…¥äº†æ–°çš„é—®é¢˜ï¼Œæ‰€ä»¥åœ¨å®é™…ä¸Šåº”ç”¨ä¸æ˜¯å¾ˆå¹¿æ³›ã€‚





## Paxos

ä»ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€åˆ°ã€ŒPaxos å°å²›çš„æ•…äº‹ã€è¯ç”Ÿäº† Paxos ç®—æ³•ã€‚

`Paxos` ç®—æ³•æ˜¯åŸºäº**æ¶ˆæ¯ä¼ é€’ä¸”å…·æœ‰é«˜åº¦å®¹é”™ç‰¹æ€§çš„ä¸€è‡´æ€§ç®—æ³•**ï¼Œæ˜¯ç›®å‰å…¬è®¤çš„è§£å†³åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜æœ€æœ‰æ•ˆçš„ç®—æ³•ä¹‹ä¸€ï¼Œ**å…¶è§£å†³çš„é—®é¢˜å°±æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¦‚ä½•å°±æŸä¸ªå€¼ï¼ˆå†³è®®ï¼‰è¾¾æˆä¸€è‡´** ã€‚

åœ¨ `Paxos` ä¸­ä¸»è¦æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œåˆ†åˆ«ä¸º `Proposerææ¡ˆè€…`ã€`Acceptorè¡¨å†³è€…`ã€`Learnerå­¦ä¹ è€…`ã€‚`Paxos` ç®—æ³•å’Œ `2PC` ä¸€æ ·ï¼Œä¹Ÿæœ‰ä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸º `Prepare` å’Œ `accept` é˜¶æ®µã€‚

åœ¨å…·ä½“çš„å®ç°ä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å¯èƒ½åŒæ—¶å……å½“å¤šç§è§’è‰²ã€‚æ¯”å¦‚ä¸€ä¸ªè¿›ç¨‹å¯èƒ½æ—¢æ˜¯ Proposer åˆæ˜¯ Acceptor åˆæ˜¯ Learnerã€‚Proposer è´Ÿè´£æå‡ºææ¡ˆï¼ŒAcceptor è´Ÿè´£å¯¹ææ¡ˆä½œå‡ºè£å†³ï¼ˆaccept ä¸å¦ï¼‰ï¼Œlearner è´Ÿè´£å­¦ä¹ ææ¡ˆç»“æœã€‚

è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå«ã€Œ**ææ¡ˆ**ã€ï¼ˆProposalï¼‰ã€‚æœ€ç»ˆè¦è¾¾æˆä¸€è‡´çš„ value å°±åœ¨ææ¡ˆé‡Œã€‚åªè¦ Proposer å‘çš„ææ¡ˆè¢«åŠæ•°ä»¥ä¸Šçš„ Acceptor æ¥å—ï¼ŒProposer å°±è®¤ä¸ºè¯¥ææ¡ˆé‡Œçš„ value è¢«é€‰å®šäº†ã€‚Acceptor å‘Šè¯‰ Learner å“ªä¸ª value è¢«é€‰å®šï¼ŒLearner å°±è®¤ä¸ºé‚£ä¸ª value è¢«é€‰å®šã€‚

#### é˜¶æ®µä¸€ï¼šprepare é˜¶æ®µ

1. `Proposer` è´Ÿè´£æå‡º `proposal`ï¼Œæ¯ä¸ªææ¡ˆè€…åœ¨æå‡ºææ¡ˆæ—¶éƒ½ä¼šé¦–å…ˆè·å–åˆ°ä¸€ä¸ªå…·æœ‰å…¨å±€å”¯ä¸€æ€§çš„ã€é€’å¢çš„ææ¡ˆç¼–å· Nï¼Œå³åœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ˜¯å”¯ä¸€çš„ç¼–å· Nï¼Œç„¶åå°†è¯¥ç¼–å·èµ‹äºˆå…¶è¦æå‡ºçš„ææ¡ˆï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µæ˜¯åªå°†ææ¡ˆç¼–å·å‘é€ç»™æ‰€æœ‰çš„è¡¨å†³è€…ã€‚
2. å¦‚æœä¸€ä¸ª Acceptor æ”¶åˆ°ä¸€ä¸ªç¼–å·ä¸º N çš„ Prepare è¯·æ±‚ï¼Œå¦‚æœå°äºå®ƒå·²ç»å“åº”è¿‡çš„è¯·æ±‚ï¼Œåˆ™ä¸å›åº”æˆ–å›å¤ error ä»¥è¡¨æ‹’ç»ã€‚è‹¥ N å¤§äºè¯¥ Acceptor å·²ç»å“åº”è¿‡çš„æ‰€æœ‰ Prepare è¯·æ±‚çš„ç¼–å·ï¼ˆmaxNï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå°†å®ƒåœ¨è¿™ä¹‹å‰å·²ç»æ‰¹å‡†è¿‡çš„ç¼–å·æœ€å¤§çš„ææ¡ˆï¼ˆå¦‚æœæœ‰çš„è¯ï¼Œå¦‚æœæ²¡æœ‰ accept è¿‡ææ¡ˆçš„è¯è¿”å›{pokï¼Œnullï¼Œnull}ï¼‰ä½œä¸ºå“åº”åé¦ˆç»™ Proposerï¼ŒåŒæ—¶è¯¥ Acceptor æ‰¿è¯ºä¸å†æ¥å—ä»»ä½•ç¼–å·å°äº N çš„ææ¡ˆ

#### é˜¶æ®µäºŒï¼šaccept é˜¶æ®µ

1. å¦‚æœä¸€ä¸ª Proposer æ”¶åˆ°åŠæ•°ä»¥ä¸Š Acceptor å¯¹å…¶å‘å‡ºçš„ç¼–å·ä¸º N çš„ Prepare è¯·æ±‚çš„å“åº”ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå‘é€ä¸€ä¸ªé’ˆå¯¹ [N,V] ææ¡ˆçš„ Accept è¯·æ±‚åŠæ•°ä»¥ä¸Šçš„ Acceptorã€‚æ³¨æ„ï¼šV å°±æ˜¯æ”¶åˆ°çš„ Acceptor å“åº”ä¸­ç¼–å·æœ€å¤§çš„ææ¡ˆçš„ valueï¼Œå¦‚æœå“åº”ä¸­ä¸åŒ…å«ä»»ä½•ææ¡ˆï¼Œé‚£ä¹ˆ V å°±ç”± Proposer è‡ªå·±å†³å®š
2. å¦‚æœ Acceptor æ”¶åˆ°ä¸€ä¸ªé’ˆå¯¹ç¼–å·ä¸º N çš„ææ¡ˆçš„ Accept è¯·æ±‚ï¼Œåªè¦è¯¥ Acceptor æ²¡æœ‰å¯¹ç¼–å·å¤§äº N çš„ Prepare è¯·æ±‚åšå‡ºè¿‡å“åº”ï¼Œå®ƒå°±é€šè¿‡è¯¥ææ¡ˆã€‚å¦‚æœ N å°äº Acceptor ä»¥åŠç›¸åº”çš„ prepare è¯·æ±‚ï¼Œåˆ™æ‹’ç»ï¼Œä¸å›åº”æˆ–å›å¤ errorï¼ˆå½“ proposer æ²¡æœ‰æ”¶åˆ°è¿‡åŠçš„å›åº”ï¼Œé‚£ä¹ˆä»–ä¼šé‡æ–°è¿›å…¥ç¬¬ä¸€é˜¶æ®µï¼Œé€’å¢ææ¡ˆå·ï¼Œé‡æ–°æå‡º prepare è¯·æ±‚ï¼‰
3. æœ€åæ˜¯ Learner è·å–é€šè¿‡çš„ææ¡ˆï¼ˆæœ‰å¤šç§æ–¹å¼ï¼‰

![img](../shortcuts/(null)-20220305163056105.(null))

#### æ­»å¾ªç¯é—®é¢˜

å…¶å®å°±æœ‰ç‚¹ç±»ä¼¼äºä¸¤ä¸ªäººåµæ¶ï¼Œå°æ˜è¯´æˆ‘æ˜¯å¯¹çš„ï¼Œå°çº¢è¯´æˆ‘æ‰æ˜¯å¯¹çš„ï¼Œä¸¤ä¸ªäººæ®ç†åŠ›äº‰çš„è°ä¹Ÿä¸è®©è°ğŸ¤¬ğŸ¤¬ã€‚

æ¯”å¦‚è¯´ï¼Œææ¡ˆè€… P1 æå‡ºä¸€ä¸ªæ–¹æ¡ˆ M1ï¼Œå®Œæˆäº† `Prepare` é˜¶æ®µçš„å·¥ä½œï¼Œè¿™ä¸ªæ—¶å€™ `acceptor` åˆ™æ‰¹å‡†äº† M1ï¼Œä½†æ˜¯æ­¤æ—¶ææ¡ˆè€… P2 åŒæ—¶ä¹Ÿæå‡ºäº†ä¸€ä¸ªæ–¹æ¡ˆ M2ï¼Œå®ƒä¹Ÿå®Œæˆäº† `Prepare` é˜¶æ®µçš„å·¥ä½œã€‚ç„¶å P1 çš„æ–¹æ¡ˆå·²ç»ä¸èƒ½åœ¨ç¬¬äºŒé˜¶æ®µè¢«æ‰¹å‡†äº†ï¼ˆå› ä¸º `acceptor` å·²ç»æ‰¹å‡†äº†æ¯” M1 æ›´å¤§çš„ M2ï¼‰ï¼Œæ‰€ä»¥ P1 è‡ªå¢æ–¹æ¡ˆå˜ä¸º M3 é‡æ–°è¿›å…¥ `Prepare` é˜¶æ®µï¼Œç„¶å `acceptor` ï¼Œåˆæ‰¹å‡†äº†æ–°çš„ M3 æ–¹æ¡ˆï¼Œå®ƒåˆä¸èƒ½æ‰¹å‡† M2 äº†ï¼Œè¿™ä¸ªæ—¶å€™ M2 åˆè‡ªå¢è¿›å…¥ `Prepare` é˜¶æ®µã€‚ã€‚ã€‚

å°±è¿™æ ·æ— ä¼‘æ— æ­¢çš„æ°¸è¿œææ¡ˆä¸‹å»ï¼Œè¿™å°±æ˜¯ `paxos` ç®—æ³•çš„æ­»å¾ªç¯é—®é¢˜ã€‚

**Solution**: å¯ä»¥é€‰æ‹©ä¸€ä¸ª Proposer ä½œä¸ºä¸» Proposerï¼Œå¹¶çº¦å®šåªæœ‰ä¸»Proposeræ‰å¯ä»¥æå‡ºææ¡ˆã€‚å› æ­¤ï¼Œåªè¦ä¸»Proposerå¯ä»¥ä¸è¿‡åŠçš„Acceptorä¿æŒé€šä¿¡ï¼Œé‚£ä¹ˆä½†å‡¡ä¸»Proposeræå‡ºçš„ç¼–å·æ›´é«˜çš„ææ¡ˆï¼Œå‡ä¼šè¢«æ‰¹å‡†ã€‚





## ZAB

ZABï¼ˆZookeeper Atomic Broadcastï¼‰åè®®æ˜¯ä¸ºåˆ†å¸ƒå¼åè°ƒæœåŠ¡ Zookeeper ä¸“é—¨è®¾è®¡çš„ä¸€ç§æ”¯æŒ**å´©æºƒæ¢å¤çš„****åŸå­****å¹¿æ’­åè®®**ã€‚

åœ¨ Zookeeper ä¸­ï¼Œä¸»è¦ä¾èµ– ZAB åè®®æ¥å®ç°åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§ï¼ŒåŸºäºè¯¥åè®®ï¼ŒZooKeeper å®ç°äº†ä¸€ç§**ä¸»å¤‡æ¨¡å¼**çš„ç³»ç»Ÿæ¶æ„æ¥ä¿æŒé›†ç¾¤ä¸­å„å‰¯æœ¬ä¹‹é—´**æ•°æ®çš„ä¸€è‡´æ€§**ã€‚

å°½ç®¡ ZAB ä¸æ˜¯ Paxos çš„å®ç°ï¼Œä½†æ˜¯ ZAB ä¹Ÿå‚è€ƒäº†ä¸€äº› Paxos è®¾è®¡æ€æƒ³ï¼Œæ¯”å¦‚ï¼š

- **leader å‘ followers æå‡ºææ¡ˆ(proposal)**

- **leader éœ€è¦åœ¨è¾¾åˆ°æ³•å®šæ•°é‡(åŠæ•°ä»¥ä¸Š)çš„ followers ç¡®è®¤ä¹‹åæ‰ä¼šè¿›è¡Œ commit**

- **æ¯ä¸€ä¸ª proposal éƒ½æœ‰ä¸€ä¸ªçºªå…ƒ(epoch)å·**

#### `**ZAB**` ä¸­çš„ä¸‰ä¸ªè§’è‰²

`ZAB` ä¸­æœ‰ä¸‰ä¸ªä¸»è¦çš„è§’è‰²ï¼Œ`Leaderé¢†å¯¼è€…`ã€`Followerè·Ÿéšè€…`ã€`Observerè§‚å¯Ÿè€…` ã€‚

- `**Leader**` **ï¼šé›†ç¾¤ä¸­å”¯ä¸€çš„å†™è¯·æ±‚å¤„ç†è€…** ï¼Œèƒ½å¤Ÿå‘èµ·æŠ•ç¥¨ï¼ˆæŠ•ç¥¨ä¹Ÿæ˜¯ä¸ºäº†è¿›è¡Œå†™è¯·æ±‚ï¼‰ã€‚

- `**Follower**`**ï¼šèƒ½å¤Ÿæ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¦‚æœæ˜¯è¯»è¯·æ±‚åˆ™å¯ä»¥è‡ªå·±å¤„ç†ï¼Œå¦‚æœæ˜¯å†™è¯·æ±‚åˆ™è¦è½¬å‘ç»™ Leader ã€‚åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­ä¼šå‚ä¸æŠ•ç¥¨ï¼Œæœ‰é€‰ä¸¾æƒå’Œè¢«é€‰ä¸¾æƒ ã€‚**

- `**Observer**` **ï¼šå°±æ˜¯æ²¡æœ‰é€‰ä¸¾æƒå’Œè¢«é€‰ä¸¾æƒçš„ Follower ã€‚**

#### æ¶ˆæ¯å¹¿æ’­æ¨¡å¼

![img](../shortcuts/(null)-20220305163055942.(null))

ZAB å¹¿æ’­

1. Leader ä»å®¢æˆ·ç«¯æ”¶åˆ°ä¸€ä¸ªææ¡ˆè¯·æ±‚ï¼ˆå¦‚æœæ˜¯é›†ç¾¤ä¸­å…¶ä»–æœºå™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„ææ¡ˆè¯·æ±‚å³ Proposalï¼Œä¼šç›´æ¥è½¬å‘ç»™ Leader æœåŠ¡å™¨ï¼‰
2. Leader æœåŠ¡å™¨ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„ææ¡ˆ Proposalï¼Œå¹¶ä¸ºè¿™ä¸ªææ¡ˆç”Ÿæˆä¸€ä¸ªå…¨å±€é€’å¢çš„å”¯ä¸€çš„ ZXIDï¼ˆé€šè¿‡å…¶ ZXID æ¥è¿›è¡Œæ’åºä¿è¯é¡ºåºæ€§ï¼‰
3. Leader å°†è¿™ä¸ªææ¡ˆå‘é€ç»™æ‰€æœ‰çš„ Followers èŠ‚ç‚¹
4. Follower èŠ‚ç‚¹å°†æ”¶åˆ°çš„ææ¡ˆè¯·æ±‚åŠ å…¥åˆ°å†å²é˜Ÿåˆ—ï¼ˆLeader ä¼šä¸ºæ¯ä¸ª Follower åˆ†é…ä¸€ä¸ªå•ç‹¬çš„é˜Ÿåˆ—å…ˆè¿›å…ˆå‡ºï¼Œé¡ºåºä¿è¯æ¶ˆæ¯çš„å› æœå…³ç³»ï¼‰ä¸­ï¼Œå¹¶å‘é€ ack ç»™ Leader
5. å½“ Leader æ”¶åˆ°è¶…è¿‡åŠæ•° Follower çš„ ack æ¶ˆæ¯ï¼ŒLeader ä¼šå¹¿æ’­ä¸€ä¸ª commit æ¶ˆæ¯
6. å½“ Follower æ”¶åˆ° commit è¯·æ±‚æ—¶ï¼Œä¼šåˆ¤æ–­è¯¥ææ¡ˆçš„ ZXID æ˜¯ä¸æ˜¯å†å²é˜Ÿåˆ—ä¸­çš„æœ€å° ZXIDï¼Œå¦‚æœæ˜¯åˆ™æäº¤ï¼Œå¦‚æœä¸æ˜¯åˆ™ç­‰å¾…æ¯”å®ƒæ›´å°çš„ææ¡ˆçš„ commit

![img](../shortcuts/(null)-20220305163056072.(null))

zab commit æµç¨‹

#### å´©æºƒæ¢å¤æ¨¡å¼

å•ç‚¹æ•…éšœé—®é¢˜ï¼šä¸€æ—¦ Leader æœåŠ¡å™¨æŒ‚æ‰æˆ–è€…ç”±äºç½‘ç»œåŸå› å¯¼è‡´ä¸åŠæ•°çš„ Follower çš„æœåŠ¡å™¨å¤±å»è”ç³»ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥å´©æºƒæ¢å¤æ¨¡å¼ã€‚æ•´ä¸ªæ¢å¤è¿‡ç¨‹ç»“æŸåéœ€è¦é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ Leader æœåŠ¡å™¨ã€‚

æ¢å¤æ¨¡å¼å¤§è‡´å¯ä»¥åˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼š**é€‰ä¸¾ã€å‘ç°ã€åŒæ­¥ã€å¹¿æ’­**

1. å½“ leader å´©æºƒåï¼Œé›†ç¾¤è¿›å…¥é€‰ä¸¾é˜¶æ®µï¼Œå¼€å§‹é€‰ä¸¾å‡ºæ½œåœ¨çš„æ–° leader (ä¸€èˆ¬ä¸ºé›†ç¾¤ä¸­æ‹¥æœ‰æœ€å¤§ ZXID çš„èŠ‚ç‚¹)
2. è¿›å…¥å‘ç°é˜¶æ®µï¼Œfollower ä¸æ½œåœ¨çš„æ–° leader è¿›è¡Œæ²Ÿé€šï¼Œå¦‚æœå‘ç°è¶…è¿‡æ³•å®šäººæ•°çš„ follower åŒæ„ï¼Œåˆ™æ½œåœ¨çš„æ–° leader å°† epoch åŠ  1ï¼Œè¿›å…¥æ–°çš„çºªå…ƒã€‚æ–°çš„ leader äº§ç”Ÿ
3. é›†ç¾¤é—´è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œä¿è¯é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹çš„ææ¡ˆä¸€è‡´
4. é›†ç¾¤æ¢å¤åˆ°å¹¿æ’­æ¨¡å¼ï¼Œå¼€å§‹æ¥å—å®¢æˆ·ç«¯çš„å†™è¯·æ±‚

##### ä¸¤ä¸ªç‰¹æ€§

æ ¹æ® ZAB æ¶ˆæ¯å¹¿æ’­çš„è¿‡ç¨‹å¯çŸ¥ï¼Œå¦‚æœä¸€ä¸ªææ¡ˆ Proposal åœ¨ä¸€å°æœºå™¨ä¸Šè¢«å¤„ç†æˆåŠŸï¼Œé‚£ä¹ˆå°±åº”è¯¥åœ¨æ‰€æœ‰çš„æœºå™¨ä¸Šå¤„ç†æˆåŠŸï¼Œå“ªæ€•æœºå™¨å‡ºç°æ•…éšœã€‚æ‰€ä»¥åœ¨å´©æºƒæ¢å¤è¿‡ç¨‹ç»“æŸåï¼Œä¸ºäº†ä¿è¯æ–°é€‰ä¸¾å‡ºæ¥çš„ Leader æœåŠ¡å™¨èƒ½æ­£å¸¸å·¥ä½œï¼Œéœ€è¦ä¿è¯ 2 ä¸ªåŸºæœ¬ç‰¹æ€§ï¼š

- **ç¡®ä¿é‚£äº›å·²ç»åœ¨ Leader æœåŠ¡å™¨ä¸Šæäº¤çš„ææ¡ˆæœ€ç»ˆè¢«æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½æäº¤**

- **ç¡®ä¿ä¸¢å¼ƒé‚£äº›åªåœ¨ Leader æœåŠ¡ä¸Šè¢«æå‡ºçš„ææ¡ˆ**

é¦–å…ˆçœ‹ç¬¬ä¸€ä¸ªç‰¹æ€§ï¼šç¡®ä¿é‚£äº›å·²ç»åœ¨ Leader æœåŠ¡å™¨ä¸Šæäº¤çš„ææ¡ˆæœ€ç»ˆè¢«æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½æäº¤ã€‚è¯•æƒ³è¿™ä¹ˆä¸ªåœºæ™¯ï¼šLeader æœåŠ¡å™¨åœ¨æ”¶åˆ°è¶…åŠæ•°çš„ ACK è¿”å›å“åº”åï¼Œæœ¬åº”è¯¥å¹¿æ’­ commit æ¶ˆæ¯ï¼Œä½†è¿™æ—¶å€™ Leader æœåŠ¡å™¨æŒ‚æ‰äº†ï¼ˆLeader æœåŠ¡å™¨å·²ç»æäº¤äº†ææ¡ˆï¼‰ï¼Œè¿™æ—¶å€™å°±ä¼šå¯¼è‡´ Follower æœåŠ¡å™¨å’Œ Leader æœåŠ¡å™¨æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚ZAB åè®®å°±é¡»ç¡®ä¿è¿™ç§å†µä¸‹ï¼Œæ‰€æœ‰çš„ Follower æœåŠ¡å™¨ä¹Ÿéƒ½æˆåŠŸæäº¤ææ¡ˆã€‚

ç¬¬äºŒä¸ªç‰¹æ€§ï¼šç¡®ä¿ä¸¢å¼ƒé‚£äº›åªåœ¨ Leader æœåŠ¡ä¸Šè¢«æå‡ºçš„ææ¡ˆã€‚è¯•æƒ³è¿™ä¹ˆä¸ªåœºæ™¯ï¼šLeader æœåŠ¡å™¨åœ¨ç”Ÿæˆ Proposal åå°±æŒ‚æ‰äº†ï¼Œå…¶ä»–çš„æœåŠ¡å™¨éƒ½æ²¡æ”¶åˆ°è¯¥ Proposalã€‚äºæ˜¯ï¼Œå½“è¯¥æœºå™¨å†æ¬¡åŠ å…¥é›†ç¾¤ä¸­çš„æ—¶å€™ï¼Œéœ€è¦ç¡®ä¿ä¸¢å¼ƒè¯¥ Proposalã€‚

æ‰€ä»¥ä¸Šé¢ä¸¤ä¸ªç‰¹æ€§æ€»ç»“å°±æ˜¯ä¸‹é¢ä¸¤å¥è¯ï¼š

- **æäº¤å·²ç»åªè¢« Leader æäº¤çš„ææ¡ˆ**

- **ä¸¢å¼ƒå·²ç»è¢«è·³è¿‡çš„ææ¡ˆ**

åŸºäºè¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œå¦‚æœè®©æ–°é€‰ä¸¾å‡ºæ¥çš„ Leader å…·æœ‰æœ€å¤§çš„ ZXID çš„ææ¡ˆ Proposalï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¿è¯è¯¥ Leader ä¸€å®šå…·æœ‰æ‰€æœ‰å·²æäº¤çš„ææ¡ˆã€‚æ›´ä¸ºé‡è¦çš„æ˜¯ï¼Œå¦‚æœè®©å…·æœ‰æœ€é«˜ ZXID çš„ææ¡ˆ Proposal çš„æœºå™¨æ¥æˆä¸º Leaderï¼Œå°±å¯ä»¥çœå» Leader æœåŠ¡å™¨æ£€æŸ¥ Proposal çš„æäº¤å’Œä¸¢å¼ƒå·¥ä½œè¿™ä¸€æ­¥æ“ä½œäº†ã€‚

##### æ•°æ®åŒæ­¥

åœ¨å®Œæˆ Leader é€‰ä¸¾ä¹‹åï¼Œåœ¨æ­£å¼å¼€å§‹å·¥ä½œï¼ˆå³æ¥æ”¶å®¢æˆ·ç«¯çš„ææ¡ˆè¯·æ±‚ï¼Œç„¶åæå‡ºæ–°çš„ææ¡ˆï¼‰ä¹‹å‰ï¼ŒLeader æœåŠ¡å™¨é¦–å…ˆä¼šç¡®ä¿ææ¡ˆæ—¥å¿—ä¸­çš„æ‰€æœ‰ Proposal æ˜¯å¦éƒ½å·²ç»è¢«é›†ç¾¤ä¸­è¿‡åŠçš„æœºå™¨æäº¤äº†ï¼Œå³æ˜¯å¦å®Œæˆæ•°æ®åŒæ­¥ã€‚

å¯¹äºé‚£äº›æ²¡æœ‰è¢« Follower æœåŠ¡å™¨æäº¤çš„ææ¡ˆï¼ŒLeader ä¼šä¸ºæ¯ä¸ª Follower æœåŠ¡å™¨å‡†å¤‡ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¹¶å°†é‚£äº›æ²¡æœ‰è¢«å„ Follower æœåŠ¡å™¨åŒæ­¥çš„ææ¡ˆä»¥ Proposal æ¶ˆæ¯çš„å½¢å¼é€ä¸ªå‘é€ç»™ Follower æœåŠ¡å™¨ï¼Œå¹¶åœ¨æ¯ä¸€ä¸ª Proposal æ¶ˆæ¯åé¢ç´§æ¥ç€å†å‘é€ä¸€ä¸ª commit æ¶ˆæ¯ï¼Œä»¥è¡¨ç¤ºè¯¥ææ¡ˆå·²è¢«æäº¤ã€‚ç­‰åˆ° Follower æœåŠ¡å™¨å°†æ‰€æœ‰æœªåŒæ­¥çš„ææ¡ˆ Proposal éƒ½ä» Leader æœåŠ¡å™¨ä¸ŠåŒæ­¥è¿‡æ¥å¹¶åº”ç”¨åˆ°æœ¬åœ°æ•°æ®åº“ï¼ŒLeader æœåŠ¡å™¨å°±å°†è¯¥ Follower æœåŠ¡å™¨åŠ å…¥åˆ°çœŸæ­£å¯ç”¨çš„ Follower åˆ—è¡¨ä¸­ã€‚

é‚£ ZAB æ˜¯å¦‚ä½•å¤„ç†é‚£äº›éœ€è¦è¢«ä¸¢å¼ƒçš„ææ¡ˆ Proposal å‘¢ï¼Ÿ

ZXID æ˜¯ä¸€ä¸ª 64 ä½çš„æ•°å­—ï¼Œå…¶ä¸­ä½ 32 ä½å¯çœ‹ä½œæ˜¯è®¡æ•°å™¨ï¼ŒLeader æœåŠ¡å™¨æ¯äº§ç”Ÿä¸€ä¸ªæ–°çš„ææ¡ˆ Proposal çš„æ—¶å€™ï¼Œè¯¥è®¡æ•°å™¨è¿›è¡ŒåŠ  1 æ“ä½œã€‚è€Œé«˜ 32 ä½è¡¨ç¤º Leader å‘¨æœŸ epoch çš„ç¼–å·ï¼Œæ¯å½“é€‰ä¸¾ä¸€ä¸ªæ–°çš„ Leader æœåŠ¡å™¨ï¼Œå°±ä¼šä»è¯¥æœåŠ¡å™¨æœ¬åœ°çš„ææ¡ˆæ—¥å¿—ä¸­æœ€å¤§ Proposal çš„ ZXID ä¸­è§£æå‡ºå¯¹åº”çš„ epoch å€¼ï¼Œç„¶åå¯¹å…¶åŠ  1 æ“ä½œï¼Œè¿™ä¸ªå€¼å°±ä½œä¸ºæ–°çš„ epoch å€¼ï¼Œå¹¶å°†ä½ 32 ä½åˆå§‹åŒ–ä¸º 0 æ¥å¼€å§‹ç”Ÿæˆæ–°çš„ ZXIDã€‚

![img](../shortcuts/(null)-20220305163056035.(null))

åŸºäºè¿™æ ·çš„ç­–ç•¥ï¼Œå½“ä¸€ä¸ªåŒ…å«ä¸Šä¸€ä¸ª Leader å‘¨æœŸä¸­å°šæœªæäº¤çš„ææ¡ˆ Proposal çš„æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œä»¥ Follower è§’è‰²åŠ å…¥é›†ç¾¤ä¸­ä¹‹åï¼ŒLeader æœåŠ¡å™¨ä¼šæ ¹æ®è‡ªå·±æœåŠ¡å™¨ä¸Šæœ€åè¢«æäº¤çš„ Proposal æ¥å’Œ Follower æœåŠ¡å™¨çš„ Proposal è¿›è¡Œæ¯”å¯¹ï¼Œæ¯”å¯¹ç»“æœå°±æ˜¯ Leader ä¼šè¦æ±‚ Follower è¿›è¡Œä¸€ä¸ªå›é€€æ“ä½œâ€”â€”å›é€€åˆ°ä¸€ä¸ªç¡®å®å·²ç»è¢«é›†ç¾¤ä¸­è¿‡åŠæœºå™¨æäº¤çš„æœ€æ–°çš„ææ¡ˆ Proposalï¼ˆä¸¢å¼ƒå·²ç»è¢«è·³è¿‡çš„ææ¡ˆï¼‰ã€‚

##### Master é€‰ä¸¾å®ç°ç»†èŠ‚

ä¸Šæ–‡è¯´è¿‡ï¼Œæ–°é€‰ä¸¾å‡ºæ¥çš„ Leader å…·æœ‰æœ€å¤§çš„ ZXID çš„ææ¡ˆ Proposalï¼Œé‚£è¿™æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ

ZAB é»˜è®¤é‡‡ç”¨ TCP ç‰ˆæœ¬çš„ FastLeaderElection é€‰ä¸¾ç®—æ³•ã€‚åœ¨é€‰ä¸¾æŠ•ç¥¨æ¶ˆæ¯ä¸­åŒ…å«äº†ä¸¤ä¸ªæœ€åŸºæœ¬çš„ä¿¡æ¯ï¼š SID å’Œ ZXIDï¼Œåˆ†åˆ«è¡¨ç¤ºè¢«æ¨ä¸¾æœåŠ¡å™¨çš„å”¯ä¸€æ ‡è¯†ï¼ˆæ¯å°æœºå™¨ä¸ä¸€æ ·ï¼‰å’Œææ¡ˆ IDã€‚å‡å¦‚æŠ•ç¥¨ä¿¡æ¯ä¸º ï¼ˆSID, ZXIDï¼‰çš„å½¢å¼ã€‚åœ¨ç¬¬ä¸€æ¬¡æŠ•ç¥¨çš„æ—¶å€™ï¼Œç”±äºè¿˜æ— æ³•æ£€æµ‹é›†ç¾¤å…¶ä»–æœºå™¨çš„çŠ¶æ€ä¿¡æ¯ï¼Œå› æ­¤æ¯å°æœºå™¨éƒ½å°†è‡ªå·±ä½œä¸ºè¢«æ¨ä¸¾çš„å¯¹è±¡æ¥è¿›è¡ŒæŠ•ç¥¨ã€‚æ¯æ¬¡å¯¹æ”¶åˆ°çš„æŠ•ç¥¨ï¼Œéƒ½æ˜¯ä¸€ä¸ªå¯¹æŠ•ç¥¨ä¿¡æ¯ï¼ˆSID, ZXIDï¼‰å¯¹æ¯”çš„è¿‡ç¨‹ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š

- **å¦‚æœæ¥æ”¶åˆ°çš„æŠ•ç¥¨ ZXID å¤§äºè‡ªå·±çš„ ZXIDï¼Œå°±è®¤å¯å½“å‰æ”¶åˆ°çš„æŠ•ç¥¨ï¼Œå¹¶å†æ¬¡å°†è¯¥æŠ•ç¥¨å‘é€å‡ºå»ã€‚**

- **å¦‚æœ ZXID å°äºè‡ªå·±çš„ ZXIDï¼Œé‚£ä¹ˆå°±åšæŒçš„æŠ•ç¥¨ï¼Œä¸åšä»»ä½•å˜æ›´ã€‚**

- **å¦‚æœ ZXID ç­‰äºè‡ªå·±çš„ ZXIDï¼Œå†å¯¹æ¯”** **SID****ï¼Œæ¯”è‡ªå·±å¤§ï¼Œå°±è®¤å¯å½“å‰æ”¶åˆ°çš„æŠ•ç¥¨ï¼Œå†å°†è¯¥æŠ•ç¥¨å‘é€å‡ºå»ï¼›å¦‚æœæ¯”è‡ªå·±å°ï¼Œé‚£å°±åšæŒè‡ªå·±çš„æŠ•ç¥¨ï¼Œä¸åšå˜æ›´ã€‚**

ç»è¿‡ç¬¬äºŒæ¬¡æŠ•ç¥¨åï¼Œé›†ç¾¤ä¸­æ¯å°æœºå™¨éƒ½ä¼šå†æ¬¡æ”¶åˆ°å…¶ä»–æœºå™¨çš„æŠ•ç¥¨ï¼Œç„¶åå¼€å§‹ç»Ÿè®¡ï¼Œå¦‚æœä¸€å°æœºå™¨æ”¶åˆ°è¶…è¿‡äº†åŠæ•°çš„ç›¸åŒæŠ•ç¥¨ï¼Œé‚£ä¹ˆè¿™ä¸ªæŠ•ç¥¨å¯¹åº”çš„ SID æœºå™¨å³ä¸º Leaderã€‚

ç®€å•æ¥è¯´ï¼Œé€šå¸¸å“ªå°æœåŠ¡å™¨ä¸Šçš„æ•°æ®è¶Šæ–°ï¼Œé‚£ä¹ˆè¶Šæœ‰å¯èƒ½æˆä¸º Leaderã€‚åŸå› å¾ˆç®€å•ï¼Œæ•°æ®è¶Šæ–°ï¼Œä¹Ÿå°±è¶Šèƒ½å¤Ÿä¿è¯æ•°æ®çš„æ¢å¤ã€‚å½“ç„¶ï¼Œå¦‚æœé›†ç¾¤ä¸­æœ‰å‡ ä¸ªæœåŠ¡å™¨å…·æœ‰ç›¸åŒçš„ ZXIDï¼Œé‚£ä¹ˆ SID è¾ƒå¤§çš„é‚£å°æœåŠ¡å™¨æˆä¸º Leaderã€‚





## Raft

å­¦ä¹ åŠ¨ç”»ï¼š[Raft](http://thesecretlivesofdata.com/raft/)

Raft æ˜¯ä¸€ä¸ªé[æ‹œå åº­](https://bytedance.feishu.cn/docs/doccnvquUJSQ6BF3cYgVfbDgUqd#tiFNHB)çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œå³æ‰€æœ‰é€šä¿¡æ˜¯æ­£ç¡®çš„è€Œéä¼ªé€ çš„ã€‚N ä¸ªç»“ç‚¹çš„æƒ…å†µä¸‹å¯ä»¥æœ€å¤šå®¹å¿ (Nâˆ’1)/2 ä¸ªç»“ç‚¹æ•…éšœã€‚

![img](../shortcuts/(null)-20220305163056123.(null))

Raft æ­£å¸¸å·¥ä½œæ—¶çš„æµç¨‹å¦‚ä¸Šå›¾ï¼Œä¹Ÿå°±æ˜¯æ­£å¸¸æƒ…å†µä¸‹æ—¥å¿—å¤åˆ¶çš„æµç¨‹ã€‚Raft ä¸­ä½¿ç”¨ **æ—¥å¿—** æ¥è®°å½•æ‰€æœ‰æ“ä½œï¼Œæ‰€æœ‰ç»“ç‚¹éƒ½æœ‰è‡ªå·±çš„æ—¥å¿—åˆ—è¡¨æ¥è®°å½•æ‰€æœ‰è¯·æ±‚ã€‚ç®—æ³•å°†æœºå™¨åˆ†æˆä¸‰ç§è§’è‰²ï¼šLeaderã€Follower å’Œ Candidateã€‚æ­£å¸¸æƒ…å†µä¸‹åªå­˜åœ¨ä¸€ä¸ª Leaderï¼Œå…¶ä»–å‡ä¸º Followerï¼Œæ‰€æœ‰å®¢æˆ·ç«¯éƒ½ä¸ Leader è¿›è¡Œäº¤äº’ã€‚

æ‰€æœ‰æ“ä½œé‡‡ç”¨ç±»ä¼¼ä¸¤é˜¶æ®µæäº¤çš„æ–¹å¼ï¼ŒLeader åœ¨æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚åå¹¶ä¸ä¼šæ‰§è¡Œï¼Œåªæ˜¯å°†å…¶å†™å…¥è‡ªå·±çš„æ—¥å¿—åˆ—è¡¨ä¸­ï¼Œç„¶åå°†è¯¥æ“ä½œå‘é€ç»™æ‰€æœ‰çš„ Followerã€‚Follower åœ¨æ”¶åˆ°è¯·æ±‚åä¹Ÿåªæ˜¯å†™å…¥è‡ªå·±çš„æ—¥å¿—åˆ—è¡¨ä¸­ç„¶åå›å¤ Leaderï¼Œå½“æœ‰è¶…è¿‡åŠæ•°çš„ç»“ç‚¹å†™å…¥å Leader æ‰ä¼šæäº¤è¯¥æ“ä½œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ï¼ŒåŒæ—¶é€šçŸ¥æ‰€æœ‰å…¶ä»–ç»“ç‚¹æäº¤è¯¥æ“ä½œã€‚

é€šè¿‡è¿™ä¸€æµç¨‹ä¿è¯äº†åªè¦æäº¤è¿‡åçš„æ“ä½œä¸€å®šåœ¨å¤šæ•°ç»“ç‚¹ä¸Šç•™æœ‰è®°å½•ï¼ˆåœ¨æ—¥å¿—åˆ—è¡¨ä¸­ï¼‰ï¼Œä»è€Œä¿è¯äº†è¯¥æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚

### é¢†å¯¼é€‰ä¸¾

åœ¨äº†è§£äº†ç®—æ³•çš„åŸºæœ¬å·¥ä½œæµç¨‹ä¹‹åï¼Œå°±è®©æˆ‘ä»¬å¼€å§‹è§£å†³å…¶ä¸­ä¼šé‡åˆ°çš„é—®é¢˜ï¼Œé¦–å…ˆå°±æ˜¯ Leader å¦‚ä½•è€Œæ¥ã€‚

#### åˆæ¬¡é€‰ä¸¾

åœ¨ç®—æ³•åˆšå¼€å§‹æ—¶ï¼Œæ‰€æœ‰ç»“ç‚¹éƒ½æ˜¯ Followerï¼Œæ¯ä¸ªç»“ç‚¹éƒ½ä¼šæœ‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯æ¬¡æ”¶åˆ°æ¥è‡ª Leader çš„ä¿¡æ¯å°±ä¼šæ›´æ–°è¯¥å®šæ—¶å™¨ã€‚

![img](../shortcuts/(null)-20220305163056193.(null))

å¦‚æœå®šæ—¶å™¨è¶…æ—¶ï¼Œè¯´æ˜ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ° Leader çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸º Leader å·²æ­»æˆ–è€…ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆè¯¥ç»“ç‚¹å°±ä¼šè½¬å˜æˆ Candidateï¼Œæ„æ€ä¸ºå‡†å¤‡ç«äº‰æˆä¸º Leaderã€‚

å°†è‡ªèº« term å€¼ +1 ï¼Œæˆä¸º Candidate åç»“ç‚¹ä¼šå‘æ‰€æœ‰å…¶ä»–ç»“ç‚¹å‘é€è¯·æ±‚æŠ•ç¥¨çš„è¯·æ±‚ï¼ˆRequestVoteï¼‰ï¼Œå…¶ä»–ç»“ç‚¹åœ¨æ”¶åˆ°è¯·æ±‚åä¼šåˆ¤æ–­æ˜¯å¦å¯ä»¥æŠ•ç»™ä»–å¹¶è¿”å›ç»“æœã€‚Candidate å¦‚æœæ”¶åˆ°äº†åŠæ•°ä»¥ä¸Šçš„æŠ•ç¥¨å°±å¯ä»¥æˆä¸º Leaderï¼Œæˆä¸ºä¹‹åä¼šç«‹å³å¹¶åœ¨ä»»æœŸå†…å®šæœŸå‘é€ä¸€ä¸ªå¿ƒè·³ä¿¡æ¯é€šçŸ¥å…¶ä»–æ‰€æœ‰ç»“ç‚¹æ­¤æ—¶æ–°çš„ Leader ä¿¡æ¯ï¼Œå¹¶ç”¨æ¥é‡ç½®å®šæ—¶å™¨ï¼Œé¿å…å…¶ä»–ç»“ç‚¹å†æ¬¡æˆä¸º Candidateã€‚

å¦‚æœ Candidate åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰è·å¾—è¶³å¤Ÿçš„æŠ•ç¥¨ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œä¸€è½®æ–°çš„é€‰ä¸¾ï¼Œç›´åˆ°å…¶æˆä¸º Leader,æˆ–è€…å…¶ä»–ç»“ç‚¹æˆä¸ºäº†æ–°çš„ Leaderï¼Œè‡ªå·±å˜æˆ Followerã€‚

#### å†æ¬¡é€‰ä¸¾

å†æ¬¡é€‰ä¸¾ä¼šåœ¨ä¸¤ç§æƒ…å†µä¸‹å‘ç”Ÿã€‚

![img](../shortcuts/(null)-20220305163056207.(null))

ç¬¬ä¸€ç§æƒ…å†µæ˜¯ Leader ä¸‹çº¿ï¼Œæ­¤æ—¶æ‰€æœ‰å…¶ä»–ç»“ç‚¹çš„è®¡æ—¶å™¨ä¸ä¼šè¢«é‡ç½®ï¼Œç›´åˆ°ä¸€ä¸ªç»“ç‚¹æˆä¸ºäº† Candidateï¼Œå’Œä¸Šè¿°ä¸€æ ·å¼€å§‹ä¸€è½®æ–°çš„é€‰ä¸¾é€‰å‡ºä¸€ä¸ªæ–°çš„ Leaderã€‚

![img](../shortcuts/(null)-20220305163056391.(null))

ç¬¬äºŒç§æƒ…å†µæ˜¯æŸä¸€ Follower ç»“ç‚¹ä¸ Leader é—´é€šä¿¡å‘ç”Ÿé—®é¢˜ï¼Œå¯¼è‡´å‘ç”Ÿäº†åˆ†åŒºï¼Œè¿™æ—¶æ²¡æœ‰ Leader çš„é‚£ä¸ªåˆ†åŒºå°±ä¼šè¿›è¡Œä¸€æ¬¡é€‰ä¸¾ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå› ä¸ºè¦æ±‚è·å¾—å¤šæ•°çš„æŠ•ç¥¨æ‰å¯ä»¥æˆä¸º Leaderï¼Œå› æ­¤åªæœ‰æ‹¥æœ‰å¤šæ•°ç»“ç‚¹çš„åˆ†åŒºå¯ä»¥æ­£å¸¸å·¥ä½œã€‚è€Œå¯¹äºå°‘æ•°ç»“ç‚¹çš„åˆ†åŒºï¼Œå³ä½¿ä»å­˜åœ¨ Leaderï¼Œä½†ç”±äºå†™å…¥æ—¥å¿—çš„ç»“ç‚¹æ•°é‡ä¸å¯èƒ½è¶…è¿‡åŠæ•°å› æ­¤ä¸å¯èƒ½æäº¤æ“ä½œã€‚è¿™è§£é‡Šäº†ä¸ºä½• Raft è‡³å¤šå®¹å¿ (Nâˆ’1)/2 ä¸ªç»“ç‚¹æ•…éšœã€‚

![img](../shortcuts/(null)-20220305163056198.(null))

è¿™è§£é‡Šäº†æ¯ä¸ªç»“ç‚¹ä¼šå¦‚ä½•åœ¨ä¸‰ä¸ªçŠ¶æ€é—´å‘ç”Ÿå˜åŒ–ã€‚

#### ä»»æœŸ Term

Leader çš„é€‰ä¸¾å¼•å‡ºäº†ä¸€ä¸ªæ–°çš„æ¦‚å¿µâ€”â€”**ä»»æœŸ**ï¼ˆTermï¼‰ã€‚

![img](../shortcuts/(null)-20220305163056214.(null))

æ¯ä¸€ä¸ªä»»æœŸä»¥ä¸€æ¬¡é€‰ä¸¾ä½œä¸ºèµ·ç‚¹ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªç»“ç‚¹æˆä¸º Candidate å¹¶å‘å…¶ä»–ç»“ç‚¹è¯·æ±‚æŠ•ç¥¨æ—¶ï¼Œä¼šå°†è‡ªå·±çš„ Term åŠ  1ï¼Œè¡¨æ˜æ–°ä¸€è½®çš„å¼€å§‹ä»¥åŠæ—§ Leader çš„ä»»æœŸç»“æŸã€‚æ‰€æœ‰èŠ‚ç‚¹åœ¨æ”¶åˆ°æ¯”è‡ªå·±æ›´å¤§çš„ Term ä¹‹åå°±ä¼šæ›´æ–°è‡ªå·±çš„ Term å¹¶è½¬æˆ Followerï¼Œè€Œæ”¶åˆ°è¿‡æ—¶çš„æ¶ˆæ¯åˆ™æ‹’ç»è¯¥è¯·æ±‚ã€‚

åœ¨ä¸€æ¬¡æˆåŠŸé€‰ä¸¾å®Œæˆåï¼ŒLeader ä¼šè´Ÿè´£ç®¡ç†æ‰€æœ‰ç»“ç‚¹ç›´è‡³ä»»æœŸç»“æŸã€‚å¦‚æœæ²¡æœ‰äº§ç”Ÿæ–°çš„ Leader å°±ä¼šå¼€å§‹ä¸€è½®æ–°çš„ Termã€‚ä»»æœŸåœ¨ Raft èµ·åˆ°äº†ç±»ä¼¼æ—¶é’Ÿçš„åŠŸèƒ½ï¼Œç”¨äºæ£€æµ‹ä¿¡æ¯æ˜¯å¦è¿‡æœŸã€‚

#### æŠ•ç¥¨é™åˆ¶

åœ¨æŠ•ç¥¨æ—¶å€™ï¼Œæ‰€æœ‰æœåŠ¡å™¨é‡‡ç”¨å…ˆæ¥å…ˆå¾—çš„åŸåˆ™ï¼Œåœ¨ä¸€ä¸ªä»»æœŸå†…åªå¯ä»¥æŠ•ç¥¨ç»™ä¸€ä¸ªç»“ç‚¹ï¼Œå¾—åˆ°è¶…è¿‡åŠæ•°çš„æŠ•ç¥¨æ‰å¯æˆä¸º Leaderï¼Œä»è€Œä¿è¯äº†ä¸€ä¸ªä»»æœŸå†…åªä¼šæœ‰ä¸€ä¸ª Leader äº§ç”Ÿï¼ˆ**Election Safety**ï¼‰ã€‚

åœ¨ Raft ä¸­æ—¥å¿—åªæœ‰ä» Leader åˆ° Follower è¿™ä¸€æµå‘ï¼Œæ‰€ä»¥éœ€è¦ä¿è¯ Leader çš„æ—¥å¿—å¿…é¡»æ­£ç¡®ï¼Œå³å¿…é¡»æ‹¥æœ‰æ‰€æœ‰å·²åœ¨å¤šæ•°èŠ‚ç‚¹ä¸Šå­˜åœ¨çš„æ—¥å¿—ï¼Œè¿™ä¸€æ­¥éª¤ç”±æŠ•ç¥¨æ¥é™åˆ¶ã€‚

![img](../shortcuts/(null)-20220305163056219.(null))

æŠ•ç¥¨ç”±ä¸€ä¸ªç§°ä¸º RequestVote çš„ RPC è°ƒç”¨è¿›è¡Œï¼Œè¯·æ±‚ä¸­é™¤äº†æœ‰ Candidate è‡ªå·±çš„ term å’Œ id ä¹‹å¤–ï¼Œè¿˜è¦å¸¦æœ‰è‡ªå·±æœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ index å’Œ termã€‚æ¥æ”¶è€…æ”¶åˆ°åé¦–å…ˆä¼šåˆ¤æ–­è¯·æ±‚çš„ term æ˜¯å¦æ›´å¤§ï¼Œä¸æ˜¯åˆ™è¯´æ˜æ˜¯æ—§æ¶ˆæ¯ï¼Œæ‹’ç»è¯¥è¯·æ±‚ã€‚å¦‚æœä»»æœŸæ›´å¤§åˆ™å¼€å§‹åˆ¤æ–­æ—¥å¿—æ˜¯å¦æ›´åŠ æ–°ã€‚æ—¥å¿— Term è¶Šå¤§åˆ™è¶Šæ–°ï¼Œç›¸åŒé‚£ä¹ˆ index è¾ƒå¤§çš„è®¤ä¸ºæ˜¯æ›´åŠ æ–°çš„æ—¥å¿—ã€‚æ¥æ”¶è€…åªä¼šæŠ•ç¥¨ç»™æ‹¥æœ‰ç›¸åŒæˆ–è€…æ›´åŠ æ–°çš„æ—¥å¿—çš„ Candidateã€‚

ç”±äºåªæœ‰æ—¥å¿—åœ¨è¢«å¤šæ•°ç»“ç‚¹å¤åˆ¶ä¹‹åæ‰ä¼šè¢«æäº¤å¹¶è¿”å›ï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ª Candidate å¹¶ä¸æ‹¥æœ‰æœ€æ–°çš„å·²è¢«å¤åˆ¶çš„æ—¥å¿—ï¼Œé‚£ä¹ˆä»–ä¸å¯èƒ½è·å¾—å¤šæ•°ç¥¨ï¼Œä»è€Œä¿è¯äº† Leader ä¸€å®šå…·æœ‰æ‰€æœ‰å·²è¢«å¤šæ•°æ‹¥æœ‰çš„æ—¥å¿—ï¼ˆ**Leader Completeness**ï¼‰ï¼Œåœ¨åç»­åŒæ­¥æ—¶ä¼šå°†å…¶åŒæ­¥ç»™æ‰€æœ‰ç»“ç‚¹ã€‚

#### å®šæ—¶å™¨æ—¶é—´

å®šæ—¶å™¨æ—¶é—´çš„è®¾å®šå®é™…ä¸Šä¹Ÿä¼šå½±å“åˆ°ç®—æ³•æ€§èƒ½ç”šè‡³æ˜¯æ­£ç¡®æ€§ã€‚è¯•æƒ³ä¸€ä¸‹è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼ŒLeader ä¸‹çº¿ï¼Œæœ‰ä¸¤ä¸ªç»“ç‚¹åŒæ—¶æˆä¸º Candidateï¼Œç„¶åç”±äºç½‘ç»œç»“æ„ç­‰åŸå› ï¼Œæ¯ä¸ªç»“ç‚¹éƒ½è·å¾—äº†ä¸€åŠçš„æŠ•ç¥¨ï¼Œå› æ­¤æ— äººæˆä¸º Leader è¿›å…¥äº†ä¸‹ä¸€è½®ã€‚ç„¶è€Œåœ¨ä¸‹ä¸€è½®ç”±äºè¿™ä¸¤ä¸ªç»“ç‚¹åŒæ—¶ç»“æŸï¼ŒåˆåŒæ—¶æˆä¸ºäº† Candidateï¼Œå†æ¬¡é‡å¤äº†ä¹‹å‰çš„è¿™ä¸€æµç¨‹ï¼Œé‚£ä¹ˆç®—æ³•å°±æ— æ³•æ­£å¸¸å·¥ä½œã€‚

ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒRaft é‡‡ç”¨äº†ä¸€ä¸ªååˆ†â€œè‰ºæœ¯â€çš„è§£å†³æ–¹æ³•ï¼Œéšæœºå®šæ—¶å™¨é•¿çŸ­ï¼ˆä¾‹å¦‚ 150-300msï¼‰ã€‚é€šè¿‡è¿™ä¸€æ–¹æ³•é¿å…äº†ä¸¤ä¸ªç»“ç‚¹åŒæ—¶æˆä¸º Candidateï¼Œå³ä½¿å‘ç”Ÿäº†ä¹Ÿèƒ½å¿«é€Ÿæ¢å¤ã€‚è¿™ä¸€é•¿çŸ­å¿…é¡»é•¿äº Leader çš„å¿ƒè·³é—´éš”ï¼Œå¦åˆ™åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¹Ÿä¼šæœ‰ Candidate å‡ºç°å¯¼è‡´ç®—æ³•æ— æ³•æ­£å¸¸å·¥ä½œã€‚

### æ—¥å¿—å¤åˆ¶

åœ¨ä¹‹å‰çš„[å·¥ä½œæµç¨‹](https://zinglix.xyz/2020/06/25/raft/#å·¥ä½œæµç¨‹)ç« èŠ‚ä¸­å·²ç»æè¿°äº†æ—¥å¿—æ˜¯å¦‚ä½•è¢«å¤åˆ¶åˆ°å…¶ä»–ç»“ç‚¹ä¸Šçš„ï¼Œä½†å®é™…ä¸­è¿˜ä¼šå‘ç”Ÿç»“ç‚¹ä¸‹çº¿ï¼Œä»è€Œäº§ç”Ÿä¸ä¸€è‡´çš„æƒ…å†µçš„å‘ç”Ÿï¼Œä¹Ÿæ˜¯è¿™ä¸€ç« æˆ‘ä»¬å°†è¦è®¨è®ºçš„å†…å®¹ã€‚

#### å‰æ

Raft ä¿è¯äº†å¦‚ä¸‹å‡ ç‚¹ï¼š

- Leader ç»ä¸ä¼šè¦†ç›–æˆ–åˆ é™¤è‡ªå·±çš„æ—¥å¿—ï¼Œåªä¼šè¿½åŠ  ï¼ˆ**Leader Append-Only**ï¼‰

- å¦‚æœä¸¤ä¸ªæ—¥å¿—çš„ index å’Œ term ç›¸åŒï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ—¥å¿—ç›¸åŒ ï¼ˆ**Log Matching**ï¼‰

- å¦‚æœä¸¤ä¸ªæ—¥å¿—ç›¸åŒï¼Œé‚£ä¹ˆä»–ä»¬ä¹‹å‰çš„æ—¥å¿—å‡ç›¸åŒ

ç¬¬ä¸€ç‚¹ä¸»è¦æ˜¯å› ä¸ºé€‰ä¸¾æ—¶çš„é™åˆ¶ï¼Œæ ¹æ® Leader Completenessï¼Œæˆä¸º Leader çš„ç»“ç‚¹é‡Œçš„æ—¥å¿—ä¸€å®šæ‹¥æœ‰æ‰€æœ‰å·²è¢«å¤šæ•°èŠ‚ç‚¹æ‹¥æœ‰çš„æ—¥å¿—æ¡ç›®ï¼Œæ‰€ä»¥å…ˆå‰çš„æ—¥å¿—æ¡ç›®å¾ˆå¯èƒ½å·²ç»è¢«æäº¤ï¼Œå› æ­¤ä¸å¯ä»¥åˆ é™¤ä¹‹å‰çš„æ—¥å¿—ã€‚

ç¬¬äºŒç‚¹ä¸»è¦æ˜¯å› ä¸ºä¸€ä¸ªä»»æœŸå†…åªå¯èƒ½å‡ºç°ä¸€ä¸ª Leaderï¼Œè€Œ Leader åªä¼šä¸ºä¸€ä¸ª index åˆ›å»ºä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œè€Œä¸”ä¸€æ—¦å†™å…¥å°±ä¸ä¼šä¿®æ”¹ï¼Œå› æ­¤ä¿è¯äº†æ—¥å¿—çš„å”¯ä¸€æ€§ã€‚

ç¬¬ä¸‰ç‚¹æ˜¯å› ä¸ºåœ¨å†™å…¥æ—¥å¿—æ—¶ä¼šæ£€æŸ¥å‰ä¸€ä¸ªæ—¥å¿—æ˜¯å¦ä¸€è‡´ã€‚æ¢è¨€ä¹‹å°±æ˜¯ï¼Œå¦‚æœå†™å…¥äº†ä¸€æ¡æ—¥å¿—ï¼Œé‚£ä¹ˆå‰ä¸€ä¸ªæ—¥å¿—æ¡ç›®ä¹Ÿä¸€å®šä¸€è‡´ï¼Œä»è€Œé€’å½’çš„ä¿è¯äº†å‰é¢çš„æ‰€æœ‰æ—¥å¿—éƒ½ä¸€è‡´ã€‚ä»è€Œä¹Ÿä¿è¯äº†å½“ä¸€ä¸ªæ—¥å¿—è¢«æäº¤ä¹‹åï¼Œæ‰€æœ‰ç»“ç‚¹åœ¨è¯¥ index ä¸Šæäº¤çš„å†…å®¹æ˜¯ä¸€æ ·çš„ï¼ˆ**State Machine Safety**ï¼‰ã€‚

#### æ—¥å¿—åŒæ­¥

æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ° Raft å®é™…ä¸­æ˜¯å¦‚ä½•åšåˆ°æ—¥å¿—åŒæ­¥çš„ã€‚è¿™ä¸€è¿‡ç¨‹ç”±ä¸€ä¸ªç§°ä¸º AppendEntries çš„ RPC è°ƒç”¨å®ç°ï¼ŒLeader ä¼šç»™æ¯ä¸ª Follower å‘é€è¯¥ RPC ä»¥è¿½åŠ æ—¥å¿—ï¼Œè¯·æ±‚ä¸­é™¤äº†å½“å‰ä»»æœŸ termã€Leader çš„ id å’Œå·²æäº¤çš„æ—¥å¿— indexï¼Œè¿˜æœ‰å°†è¦è¿½åŠ çš„æ—¥å¿—åˆ—è¡¨ï¼ˆç©ºåˆ™æˆä¸ºå¿ƒè·³åŒ…ï¼‰ï¼Œå‰ä¸€ä¸ªæ—¥å¿—çš„ index å’Œ termã€‚

![img](../shortcuts/(null)-20220305163056311.(null))

å½“æ¥æ”¶åˆ°è¯¥è¯·æ±‚åï¼Œä¼šå…ˆæ£€æŸ¥ termï¼Œå¦‚æœè¯·æ±‚ä¸­çš„ term æ¯”è‡ªå·±çš„å°è¯´æ˜å·²è¿‡æœŸï¼Œæ‹’ç»è¯·æ±‚ã€‚ä¹‹åä¼šå¯¹æ¯”å…ˆå‰æ—¥å¿—çš„ index å’Œ termï¼Œå¦‚æœä¸€è‡´ï¼Œé‚£ä¹ˆç”±å‰æå¯çŸ¥å‰é¢çš„æ—¥å¿—å‡ç›¸åŒï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»æ­¤å¤„æ›´æ–°æ—¥å¿—ï¼Œå°†è¯·æ±‚ä¸­çš„æ‰€æœ‰æ—¥å¿—å†™å…¥è‡ªå·±çš„æ—¥å¿—åˆ—è¡¨ä¸­ï¼Œå¦åˆ™è¿”å› falseã€‚å¦‚æœå‘ç”Ÿ index ç›¸åŒä½† term ä¸åŒåˆ™æ¸…ç©ºåç»­æ‰€æœ‰çš„æ—¥å¿—ï¼Œä»¥ Leader ä¸ºå‡†ã€‚æœ€åæ£€æŸ¥å·²æäº¤çš„æ—¥å¿— indexï¼Œå¯¹å¯æäº¤çš„æ—¥å¿—è¿›è¡Œæäº¤æ“ä½œã€‚

å¯¹äº Leader æ¥è¯´ä¼šç»´æŠ¤ nextIndex[] å’Œ matchIndex[] ä¸¤ä¸ªæ•°ç»„ï¼Œåˆ†åˆ«è®°å½•äº†æ¯ä¸ª Follower ä¸‹ä¸€ä¸ªå°†è¦å‘é€çš„æ—¥å¿— index å’Œå·²ç»åŒ¹é…ä¸Šçš„æ—¥å¿— indexã€‚æ¯æ¬¡æˆä¸º Leader éƒ½ä¼šåˆå§‹åŒ–è¿™ä¸¤ä¸ªæ•°ç»„ï¼Œå‰è€…åˆå§‹åŒ–ä¸º Leader æœ€åä¸€æ¡æ—¥å¿—çš„ index åŠ  1ï¼Œåè€…åˆå§‹åŒ–ä¸º 0ã€‚æ¯æ¬¡å‘é€ RPC æ—¶ä¼šå‘é€ nextIndex[i] åŠä¹‹åçš„æ—¥å¿—ï¼ŒæˆåŠŸåˆ™æ›´æ–°ä¸¤ä¸ªæ•°ç»„ï¼Œå¦åˆ™å‡å°‘ nextIndex[i] çš„å€¼é‡è¯•ï¼Œé‡å¤è¿™ä¸€è¿‡ç¨‹ç›´è‡³æˆåŠŸã€‚

> *è¿™é‡Œå‡å°‘ nextIndex çš„å€¼æœ‰ä¸åŒçš„ç­–ç•¥ï¼Œå¯ä»¥æ¯æ¬¡å‡ä¸€ï¼Œä¹Ÿå¯ä»¥å‡ä¸€ä¸ªè¾ƒå¤§çš„å€¼ï¼Œæˆ–è€…æ˜¯è·¨ä»»æœŸå‡å°‘ï¼Œç”¨äºå¿«é€Ÿæ‰¾åˆ°å’Œè¯¥ç»“ç‚¹ç›¸åŒ¹é…çš„æ—¥å¿—æ¡ç›®ã€‚å®é™…ä¸­è¿˜æœ‰å¯èƒ½ä¼šå®šæœŸå­˜å‚¨æ—¥å¿—ï¼Œæ‰€ä»¥å½“å‰æ—¥å¿—åˆ—è¡¨ä¸­å¹¶ä¸ä¼šå¤ªå¤§ï¼Œå¯ä»¥å®Œæ•´æ‰“åŒ…å‘ç»™å¯¹æ–¹ï¼Œè¿™ä¸€åšæ³•æ¯”è¾ƒé€‚åˆæ–°åŠ å…¥é›†ç¾¤çš„ç»“ç‚¹ã€‚*

#### æ—¥å¿—æäº¤

åªè¦æ—¥å¿—åœ¨å¤šæ•°ç»“ç‚¹ä¸Šå­˜åœ¨ï¼Œé‚£ä¹ˆ Leader å°±å¯ä»¥æäº¤è¯¥æ“ä½œã€‚ä½†æ˜¯ Raft é¢å¤–é™åˆ¶äº† Leader åªå¯¹è‡ªå·±ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®é€‚ç”¨è¯¥è§„åˆ™ï¼Œå…ˆå‰ä»»æœŸçš„æ¡ç›®åªèƒ½ç”±å½“å‰ä»»æœŸçš„æäº¤è€Œé—´æ¥è¢«æäº¤ã€‚

![img](../shortcuts/(null)-20220305163056308.(null))

ä¾‹å¦‚è®ºæ–‡ä¸­å›¾ 8 è¿™ä¸€ corner caseã€‚ä¸€å¼€å§‹å¦‚ (a) æ‰€ç¤ºï¼Œä¹‹å S1 ä¸‹çº¿ï¼Œ(b) ä¸­ S5 ä» S3 å’Œ S4 å¤„è·å¾—äº†æŠ•ç¥¨æˆä¸ºäº† Leader å¹¶æ”¶åˆ°äº†ä¸€æ¡æ¥è‡ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯ï¼Œä¹‹å S5 ä¸‹çº¿ã€‚(c) ä¸­ S1 æ¢å¤å¹¶æˆä¸ºäº† Leaderï¼Œå¹¶ä¸”å°†æ—¥å¿—å¤åˆ¶ç»™äº†å¤šæ•°ç»“ç‚¹ï¼Œä¹‹åè¿›è¡Œäº†ä¸€ä¸ªè‡´å‘½æ“ä½œï¼Œå°† index ä¸º 2 çš„æ—¥å¿—æäº¤äº†ï¼Œç„¶å S1 ä¸‹çº¿ã€‚(d) ä¸­ S5 æ¢å¤ï¼Œå¹¶ä» S2ã€S3ã€S4 å¤„è·å¾—äº†è¶³å¤ŸæŠ•ç¥¨ï¼Œç„¶åå°†å·²æäº¤çš„ index ä¸º 2 çš„æ—¥å¿—è¦†ç›–äº†ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRaft åªå…è®¸æäº¤è‡ªå·±ä»»æœŸå†…çš„æ—¥å¿—ï¼Œä»è€Œæ—¥å¿— 2 åªèƒ½åƒ (e) ä¸­ç”±äºæ—¥å¿— 3 åŒæ­¥è€Œè¢«é—´æ¥æäº¤ï¼Œé¿å…äº† Follower ä¸­ç”±äºç¼ºå°‘æ–°ä»»æœŸçš„æ—¥å¿—ï¼Œä½¿å¾— S5 èƒ½å¤Ÿç»§ç»­æˆä¸º Leaderã€‚





## Paxos vs ZAB vs Raft

|          | **[Paxos](https://bytedance.feishu.cn/docs/doccnvquUJSQ6BF3cYgVfbDgUqd#dvx13b)** | **[ZAB](https://bytedance.feishu.cn/docs/doccnvquUJSQ6BF3cYgVfbDgUqd#91Dnmv)** | **[Raft](https://bytedance.feishu.cn/docs/doccnvquUJSQ6BF3cYgVfbDgUqd#6mx5aG)** |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| è§’è‰²     | `Proposerææ¡ˆè€…`ã€`Acceptorè¡¨å†³è€…`ã€`Learnerå­¦ä¹ è€…`          | `Leaderé¢†å¯¼è€…`ã€`Followerè·Ÿéšè€…`ã€`Observerè§‚å¯Ÿè€…`           | `Leader`ã€`Follower` å’Œ `Candidate`                          |
| é‡è¦æ¦‚å¿µ | ææ¡ˆã€‚æœ€ç»ˆè¦è¾¾æˆä¸€è‡´çš„ value å°±åœ¨ææ¡ˆé‡Œã€‚åªè¦ Proposer å‘çš„ææ¡ˆè¢«åŠæ•°ä»¥ä¸Šçš„ Acceptor æ¥å—ï¼ŒProposer å°±è®¤ä¸ºè¯¥ææ¡ˆé‡Œçš„ value è¢«é€‰å®šäº†ã€‚ | ZAB å‚è€ƒäº†ä¸€äº› Paxos è®¾è®¡æ€æƒ³ï¼Œæ¯”å¦‚ï¼š leader å‘ followers æå‡ºææ¡ˆ(proposal) leader éœ€è¦åœ¨è¾¾åˆ°æ³•å®šæ•°é‡(åŠæ•°ä»¥ä¸Š)çš„ followers ç¡®è®¤ä¹‹åæ‰ä¼šè¿›è¡Œ commit æ¯ä¸€ä¸ª proposal éƒ½æœ‰ä¸€ä¸ªçºªå…ƒ(epoch)å· | å¦‚æœå®šæ—¶å™¨è¶…æ—¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸º Leader å·²æ­»æˆ–è€…ä¸å­˜åœ¨ï¼Œç»“ç‚¹å°±ä¼šè½¬å˜æˆ Candidateã€‚ å°†è‡ªèº« term å€¼ +1 ï¼Œæˆä¸º Candidate åç»“ç‚¹ä¼šå‘æ‰€æœ‰å…¶ä»–ç»“ç‚¹å‘é€è¯·æ±‚æŠ•ç¥¨çš„è¯·æ±‚ï¼Œå…¶ä»–ç»“ç‚¹åœ¨æ”¶åˆ°è¯·æ±‚åä¼šåˆ¤æ–­æ˜¯å¦å¯ä»¥æŠ•ç»™ä»–å¹¶è¿”å›ç»“æœã€‚Candidate å¦‚æœæ”¶åˆ°äº†åŠæ•°ä»¥ä¸Šçš„æŠ•ç¥¨å°±å¯ä»¥æˆä¸º Leaderï¼Œæˆä¸ºä¹‹åä¼šç«‹å³å¹¶åœ¨ä»»æœŸå†…å®šæœŸå‘é€ä¸€ä¸ªå¿ƒè·³ä¿¡æ¯é€šçŸ¥å…¶ä»–æ‰€æœ‰ç»“ç‚¹æ­¤æ—¶æ–°çš„ Leader ä¿¡æ¯ï¼Œå¹¶ç”¨æ¥é‡ç½®å®šæ—¶å™¨ï¼Œé¿å…å…¶ä»–ç»“ç‚¹å†æ¬¡æˆä¸º Candidateã€‚ |



# æ‰©å±•

## æ‹œå åº­å°†å†›é—®é¢˜

> æ‹œå åº­å°†å†›é—®é¢˜æ˜¯ä¸€ä¸ªåè®®é—®é¢˜ï¼Œæ‹œå åº­å¸å›½å†›é˜Ÿçš„å°†å†›ä»¬å¿…é¡»å…¨ä½“ä¸€è‡´çš„å†³å®šæ˜¯å¦æ”»å‡»æŸä¸€æ”¯æ•Œå†›ã€‚é—®é¢˜æ˜¯è¿™äº›å°†å†›åœ¨åœ°ç†ä¸Šæ˜¯åˆ†éš”å¼€æ¥çš„ï¼Œå¹¶ä¸”å°†å†›ä¸­å­˜åœ¨å›å¾’ã€‚å›å¾’å¯ä»¥ä»»æ„è¡ŒåŠ¨ä»¥è¾¾åˆ°ä»¥ä¸‹ç›®æ ‡ï¼šæ¬ºéª—æŸäº›å°†å†›é‡‡å–è¿›æ”»è¡ŒåŠ¨ï¼›ä¿ƒæˆä¸€ä¸ªä¸æ˜¯æ‰€æœ‰å°†å†›éƒ½åŒæ„çš„å†³å®šï¼Œå¦‚å½“å°†å†›ä»¬ä¸å¸Œæœ›è¿›æ”»æ—¶ä¿ƒæˆè¿›æ”»è¡ŒåŠ¨ï¼›æˆ–è€…è¿·æƒ‘æŸäº›å°†å†›ï¼Œä½¿ä»–ä»¬æ— æ³•åšå‡ºå†³å®šã€‚å¦‚æœå›å¾’è¾¾åˆ°äº†è¿™äº›ç›®çš„ä¹‹ä¸€ï¼Œåˆ™ä»»ä½•æ”»å‡»è¡ŒåŠ¨çš„ç»“æœéƒ½æ˜¯æ³¨å®šè¦å¤±è´¥çš„ï¼Œåªæœ‰å®Œå…¨è¾¾æˆä¸€è‡´çš„åŠªåŠ›æ‰èƒ½è·å¾—èƒœåˆ©ã€‚

è¿™ä¸€é—®é¢˜æ˜¯ä¸€ç§å¯¹ç°å®ä¸–ç•Œçš„æ¨¡å‹åŒ–ï¼Œå°¤æŒ‡ç½‘ç»œå½“ä¸­ç”±äºè½¯ç¡¬ä»¶é”™è¯¯ã€ç½‘ç»œé˜»å¡åŠæ¶æ„æ”»å‡»å¯¼è‡´çš„å„ç§æœªçŸ¥è¡Œä¸ºã€‚

æ‹œå åº­å°†å†›é—®é¢˜æå‡ºåï¼Œæœ‰å¾ˆå¤šçš„ç®—æ³•è¢«æå‡ºç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¿™ç±»ç®—æ³•ç»Ÿç§°æ‹œå åº­å®¹é”™ç®—æ³•ï¼ˆBFT: Byzantine Fault Toleranceï¼‰ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼Œæ‹œå åº­å®¹é”™æ–¹æ¡ˆå°±æ˜¯å°‘æ•°æœä»å¤šæ•°ã€‚

æ‹œå åº­ç³»ç»Ÿç›®å‰æ™®éé‡‡ç”¨çš„å‡è®¾æ¡ä»¶åŒ…æ‹¬:

- [æ‹œå åº­èŠ‚ç‚¹](https://www.zhihu.com/search?q=æ‹œå åº­èŠ‚ç‚¹&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra={"sourceType":"article","sourceId":217827966})çš„è¡Œä¸ºå¯ä»¥æ˜¯ä»»æ„çš„ï¼Œæ‹œå åº­èŠ‚ç‚¹ä¹‹é—´å¯ä»¥å…±è°‹ï¼›

- èŠ‚ç‚¹ä¹‹é—´çš„é”™è¯¯æ˜¯ä¸ç›¸å…³çš„ï¼›

- èŠ‚ç‚¹ä¹‹é—´é€šè¿‡å¼‚æ­¥ç½‘ç»œè¿æ¥ï¼Œç½‘ç»œä¸­çš„æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ã€ä¹±åºã€å»¶æ—¶åˆ°è¾¾ï¼›

- æœåŠ¡å™¨ä¹‹é—´ä¼ é€’çš„ä¿¡æ¯, ç¬¬ä¸‰æ–¹å¯ä»¥çŸ¥æ™“ ,ä½†æ˜¯ä¸èƒ½ç¯¡æ”¹ã€ä¼ªé€ ä¿¡æ¯çš„å†…å®¹å’ŒéªŒè¯ä¿¡æ¯çš„å®Œæ•´æ€§ï¼›

### BFT å…±è¯†æœºåˆ¶

åœ¨ BFT å…±è¯†æœºåˆ¶ä¸­ï¼Œç½‘ç»œä¸­èŠ‚ç‚¹çš„æ•°é‡å’Œèº«ä»½å¿…é¡»æ˜¯æå‰ç¡®å®šå¥½çš„ã€‚ä¸”æ¯ä¸€æ¬¡èŠ‚ç‚¹çš„è¿›å‡ºéƒ½éœ€è¦å¯¹ç½‘ç»œè¿›è¡Œåˆå§‹åŒ–ï¼Œæ•…å…¶æ— æ³•åƒ PoW å…±è¯†æœºåˆ¶é‚£æ ·ä»»ä½•äººéƒ½å¯ä»¥éšæ—¶åŠ å…¥/é€€å‡ºæŒ–çŸ¿ã€‚å¦å¤–ï¼Œç”±äºèŠ‚ç‚¹é—´åŸºäºæ¶ˆæ¯ä¼ é€’è¾¾æˆå…±è¯†ï¼Œå› æ­¤é‡‡ç”¨BFTç®—æ³•çš„ç½‘ç»œæ— æ³•æ‰¿è½½å¤§é‡çš„èŠ‚ç‚¹ï¼Œä¸šå†…æ™®éè®¤ä¸º100ä¸ªèŠ‚ç‚¹æ˜¯BFTç®—æ³•çš„ä¸Šé™ã€‚æ‰€ä»¥BFTç®—æ³•æ— æ³•ç›´æ¥ç”¨äºå…¬æœ‰é“¾ï¼Œè€Œæ›´å¤šçš„åº”ç”¨äºç§æœ‰é“¾å’Œè”ç›Ÿé“¾ã€‚ä¸šå†…å¤§åé¼é¼çš„è”ç›Ÿé“¾Hyperledger fabric v0.6é‡‡ç”¨çš„æ˜¯PBFTï¼Œv1.0åˆæ¨å‡ºPBFTçš„æ”¹è¿›ç‰ˆæœ¬SBFTã€‚åç»­åˆæœ‰ç›¸å½“å¤šçš„äººå¯¹å…¶è¿›è¡Œäº†æ”¹è¿›ï¼ŒåŠ›æ±‚æé«˜å…¶æ‰©å±•æ€§ã€‚ä½†å¾€å¾€éƒ½æ˜¯åŸºäºå¯¹ç½‘ç»œç¯å¢ƒçš„ç†æƒ³å‡è®¾ï¼Œä»¥çœå»éƒ¨åˆ†å…±è¯†é˜¶æ®µï¼Œå®ç°æ›´é«˜çš„[èŠ‚ç‚¹æ‰¿è½½é‡](https://www.zhihu.com/search?q=èŠ‚ç‚¹æ‰¿è½½é‡&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra={"sourceType":"article","sourceId":217827966})ã€‚

åœ¨å¯ä¿¡ç¯å¢ƒä¸‹å…±è¯†ç®—æ³•ä¸€èˆ¬ä½¿ç”¨ä¼ ç»Ÿçš„åˆ†å¸ƒå¼ä¸€è‡´ç®—æ³• PAXOS æˆ–è€… RAFTã€‚

![img](../shortcuts/(null)-20220305163056329.(null))

## PBFT

å‚è€ƒ [å®ç”¨æ‹œå åº­å®¹é”™æœºåˆ¶ç†è§£](https://zhuanlan.zhihu.com/p/217827966)

**ä¸ºä»€ä¹ˆ PBFT ç®—æ³•æœ€å¤§å®¹é”™èŠ‚ç‚¹æ•°é‡ f æ˜¯ (N-1)/3**

å‡å®šç³»ç»ŸèŠ‚ç‚¹æ€»æ•°æ˜¯Nï¼Œä½œæ¶èŠ‚ç‚¹æ•°ä¸ºfï¼Œé‚£ä¹ˆå‰©ä¸‹çš„æ­£ç¡®èŠ‚ç‚¹æ•°ä¸ºN - fï¼Œæ„å‘³ç€åªè¦æ”¶åˆ°N - fä¸ªæ¶ˆæ¯ä¸”N - f > få°±èƒ½åšå‡ºå†³å®šï¼Œä½†è¿˜è¦æ³¨æ„æ”¶åˆ°çš„ N - f ä¸ªæ¶ˆæ¯æœ‰å¯èƒ½æœ‰ f ä¸ªæ˜¯ç”±ä½œæ¶èŠ‚ç‚¹å†’å……çš„ï¼ˆæˆ–å› ç½‘ç»œå»¶è¿Ÿå¯¼è‡´ f ä¸ª[æ¶æ„èŠ‚ç‚¹](https://www.zhihu.com/search?q=æ¶æ„èŠ‚ç‚¹&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra={"sourceType":"article","sourceId":217827966})çš„æ¶ˆæ¯å…ˆè¢«æ”¶åˆ°ï¼‰ï¼Œé‚£ä¹ˆæ­£ç¡®çš„æ¶ˆæ¯å°±æ˜¯ N - f - f ä¸ªï¼Œä¸ºäº†å¤šæ•°ä¸€è‡´ï¼Œæ­£ç¡®æ¶ˆæ¯å¿…é¡»å å¤šæ•°ï¼Œä¹Ÿå°±æ˜¯N - f - f > f ï¼Œæ‰€ä»¥Næœ€å°‘æ˜¯ 3f + 1 ä¸ªã€‚

# å‚è€ƒ

[In search of an Understandable Consensus Algorithm (Extended Version) | Raft](https://ramcloud.atlassian.net/wiki/download/attachments/6586375/raft.pdf)

[wiki | åˆ†å¸ƒå¼è®¡ç®—](https://zh.wikipedia.org/wiki/åˆ†å¸ƒå¼è®¡ç®—)

[ã€Œåˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ã€ä»2PCã€3PCã€Paxosåˆ° ZAB](https://xie.infoq.cn/article/0b443ad92ada320b06f669dba)

[è°ˆè°ˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„CAPç†è®º](https://zhuanlan.zhihu.com/p/33999708)

[è½»æ¾ç†è§£CAPç†è®º](https://zhuanlan.zhihu.com/p/50990721)

[åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€è‡´æ€§åè®®ä¹‹ 2PC å’Œ 3PC | Matt's Blog](https://matt33.com/2018/07/08/distribute-system-consistency-protocol)

 [2PCåˆ°3PCåˆ°Paxosåˆ°Raftåˆ°ISR](https://segmentfault.com/a/1190000004474543)

[ZooKeeper ä¸€è‡´æ€§åè®® ZAB åŸç†åˆ†æ! - æ˜é‡‘](https://juejin.cn/post/6844903806723964936)

[å®ç”¨æ‹œå åº­å®¹é”™æœºåˆ¶ç†è§£](https://zhuanlan.zhihu.com/p/217827966)

[ã€Œå›¾è§£Raftã€è®©ä¸€è‡´æ€§ç®—æ³•å˜å¾—æ›´ç®€å•](https://zinglix.xyz/2020/06/25/raft/)